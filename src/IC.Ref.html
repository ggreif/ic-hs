<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE TypeOperators #-}</span><span>
</span><span id="line-2"></span><span class="hs-pragma">{-# LANGUAGE TypeApplications #-}</span><span>
</span><span id="line-3"></span><span class="hs-pragma">{-# LANGUAGE ConstraintKinds #-}</span><span>
</span><span id="line-4"></span><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><span id="line-5"></span><span class="hs-pragma">{-# LANGUAGE LambdaCase #-}</span><span>
</span><span id="line-6"></span><span class="hs-pragma">{-# LANGUAGE NamedFieldPuns #-}</span><span>
</span><span id="line-7"></span><span class="hs-pragma">{-# LANGUAGE TypeFamilies #-}</span><span>
</span><span id="line-8"></span><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><span id="line-9"></span><span class="hs-pragma">{-# LANGUAGE RankNTypes #-}</span><span>
</span><span id="line-10"></span><span class="hs-pragma">{-# LANGUAGE OverloadedLabels #-}</span><span>
</span><span id="line-11"></span><span class="hs-pragma">{-# LANGUAGE OverloadedStrings #-}</span><span>
</span><span id="line-12"></span><span class="hs-pragma">{-# LANGUAGE DataKinds #-}</span><span>
</span><span id="line-13"></span><span class="hs-pragma">{-# LANGUAGE AllowAmbiguousTypes #-}</span><span>
</span><span id="line-14"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-15"></span><span class="hs-pragma">{-# LANGUAGE NumericUnderscores #-}</span><span>
</span><span id="line-16"></span><span class="hs-pragma">{-# LANGUAGE MultiWayIf #-}</span><span>
</span><span id="line-17"></span><span>
</span><span id="line-18"></span><span class="hs-comment">{-|
This module implements the main abstract logic of the Internet Computer. It
assumes a pure and abstracted view on Canisters (provided by &quot;IC.Canister&quot;),
and deals with abstract requests ('CallRequest', 'QueryRequest', ...), so HTTP
and CBOR-level processing has already happened.
-}</span><span>
</span><span id="line-24"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">IC.Ref</span><span>
</span><span id="line-25"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier">IC</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-26"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier">CallRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-27"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#callerOfCallRequest"><span class="hs-identifier">callerOfCallRequest</span></a></span><span>
</span><span id="line-28"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier">QueryRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-29"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier">ReadStateRequest</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-30"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#RequestStatus"><span class="hs-identifier">RequestStatus</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReqResponse"><span class="hs-identifier">ReqResponse</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-32"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier">CallResponse</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-33"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#initialIC"><span class="hs-identifier">initialIC</span></a></span><span>
</span><span id="line-34"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier">authCallRequest</span></a></span><span>
</span><span id="line-35"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier">authQueryRequest</span></a></span><span>
</span><span id="line-36"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier">authReadStateRequest</span></a></span><span>
</span><span id="line-37"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#submitRequest"><span class="hs-identifier">submitRequest</span></a></span><span>
</span><span id="line-38"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#handleQuery"><span class="hs-identifier">handleQuery</span></a></span><span>
</span><span id="line-39"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#handleReadState"><span class="hs-identifier">handleReadState</span></a></span><span>
</span><span id="line-40"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#runStep"><span class="hs-identifier">runStep</span></a></span><span>
</span><span id="line-41"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier">runToCompletion</span></a></span><span>
</span><span id="line-42"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#processSystemTasks"><span class="hs-identifier">processSystemTasks</span></a></span><span>
</span><span id="line-43"></span><span>  </span><span class="annot"><span class="hs-comment">-- $ Exported for use as a library, e.g. in testing</span></span><span>
</span><span id="line-44"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier">setAllTimesTo</span></a></span><span>
</span><span id="line-45"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#createEmptyCanister"><span class="hs-identifier">createEmptyCanister</span></a></span><span>
</span><span id="line-46"></span><span>  </span><span class="annot"><span class="hs-comment">-- $ Exported merely for debug introspection</span></span><span>
</span><span id="line-47"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier">CallContext</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-48"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Message"><span class="hs-identifier">Message</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-49"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier">CanState</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-50"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallOrigin"><span class="hs-identifier">CallOrigin</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-51"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#EntryPoint"><span class="hs-identifier">EntryPoint</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-52"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#RunStatus"><span class="hs-identifier">RunStatus</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-53"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanisterContent"><span class="hs-identifier">CanisterContent</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-54"></span><span>  </span><span class="hs-special">)</span><span>
</span><span id="line-55"></span><span class="hs-keyword">where</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.html"><span class="hs-identifier">Data.Map</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-58"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.html"><span class="hs-identifier">Data.Row</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">R</span></span><span>
</span><span id="line-59"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/bytestring-0.10.12.1/src/Data.ByteString.Lazy.html"><span class="hs-identifier">Data.ByteString.Lazy</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">BS</span></span><span>
</span><span id="line-60"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html"><span class="hs-identifier">Data.Text</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">T</span></span><span>
</span><span id="line-61"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Set.html"><span class="hs-identifier">Data.Set</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">S</span></span><span>
</span><span id="line-62"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Word.html"><span class="hs-identifier">Data.Word</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">W</span></span><span>
</span><span id="line-63"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.List.html"><span class="hs-identifier">Data.List</span></a></span><span>
</span><span id="line-64"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Maybe.html"><span class="hs-identifier">Data.Maybe</span></a></span><span>
</span><span id="line-65"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html"><span class="hs-identifier">Control.Monad.State.Class</span></a></span><span>
</span><span id="line-66"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Except.html"><span class="hs-identifier">Control.Monad.Except</span></a></span><span>
</span><span id="line-67"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Sequence.html"><span class="hs-identifier">Data.Sequence</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Sequence.Internal.html#Seq"><span class="hs-identifier">Seq</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-68"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html"><span class="hs-identifier">Data.Foldable</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#toList"><span class="hs-identifier">toList</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-69"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/5q8knwbpcq1xjhfifih1jfwmvd2jr0sg-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.html"><span class="hs-identifier">Codec.Candid</span></a></span><span>
</span><span id="line-70"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.html"><span class="hs-identifier">Data.Row</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#.%21"><span class="hs-operator">(.!)</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-71"></span><span>
</span><span id="line-72"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Types.html"><span class="hs-identifier">IC.Types</span></a></span><span>
</span><span id="line-73"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Canister.html"><span class="hs-identifier">IC.Canister</span></a></span><span>
</span><span id="line-74"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.CBOR.Utils.html"><span class="hs-identifier">IC.CBOR.Utils</span></a></span><span>
</span><span id="line-75"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Id.Fresh.html"><span class="hs-identifier">IC.Id.Fresh</span></a></span><span>
</span><span id="line-76"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Utils.html"><span class="hs-identifier">IC.Utils</span></a></span><span>
</span><span id="line-77"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Management.html"><span class="hs-identifier">IC.Management</span></a></span><span>
</span><span id="line-78"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.HashTree.html"><span class="hs-identifier">IC.HashTree</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.HashTree.html#Blob"><span class="hs-identifier">Blob</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-79"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.html"><span class="hs-identifier">IC.Certificate</span></a></span><span>
</span><span id="line-80"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html"><span class="hs-identifier">IC.Certificate.Value</span></a></span><span>
</span><span id="line-81"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Certificate.CBOR.html"><span class="hs-identifier">IC.Certificate.CBOR</span></a></span><span>
</span><span id="line-82"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Crypto.html"><span class="hs-identifier">IC.Crypto</span></a></span><span>
</span><span id="line-83"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Ref.Management.html"><span class="hs-identifier">IC.Ref.Management</span></a></span><span>
</span><span id="line-84"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="IC.Ref.Types.html"><span class="hs-identifier">IC.Ref.Types</span></a></span><span>
</span><span id="line-85"></span><span>
</span><span id="line-86"></span><span class="hs-comment">-- Request handling</span><span>
</span><span id="line-87"></span><span>
</span><span id="line-88"></span><span class="annot"><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-type">findRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-89"></span><span id="findRequest"><span class="annot"><span class="annottext">findRequest :: Blob -&gt; IC -&gt; Maybe (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-var hs-var">findRequest</span></a></span></span><span> </span><span id="local-6989586621679336525"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336525"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679336524"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679336524"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
-&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
-&gt; Maybe (CallRequest, (RequestStatus, CanisterId))
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336525"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679336524"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-90"></span><span>
</span><span id="line-91"></span><span id="local-6989586621679336912"><span class="annot"><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-type">setReqStatus</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336912"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#RequestStatus"><span class="hs-identifier hs-type">RequestStatus</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336912"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-92"></span><span id="setReqStatus"><span class="annot"><span class="annottext">setReqStatus :: forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var hs-var">setReqStatus</span></a></span></span><span> </span><span id="local-6989586621679336515"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336515"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679336514"><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679336514"><span class="hs-identifier hs-var">s</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679336512"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679336512"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-93"></span><span>  </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679336512"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">requests :: Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((CallRequest, (RequestStatus, CanisterId))
 -&gt; (CallRequest, (RequestStatus, CanisterId)))
-&gt; Blob
-&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
-&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
forall k a. Ord k =&gt; (a -&gt; a) -&gt; k -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#adjust"><span class="hs-identifier hs-var">M.adjust</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679336510"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679336510"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679336509"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336509"><span class="hs-identifier hs-var">ecid</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679336510"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679336514"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336509"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336515"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679336512"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-94"></span><span>
</span><span id="line-95"></span><span class="annot"><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-type">calleeOfCallRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span>
</span><span id="line-96"></span><span id="calleeOfCallRequest"><span class="annot"><span class="annottext">calleeOfCallRequest :: CallRequest -&gt; CanisterId
</span><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-var hs-var">calleeOfCallRequest</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-97"></span><span>    </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679336505"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336505"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336505"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-98"></span><span>
</span><span id="line-99"></span><span class="hs-comment">-- Canister handling</span><span>
</span><span id="line-100"></span><span>
</span><span id="line-101"></span><span id="local-6989586621679336896"><span class="annot"><a href="IC.Ref.html#doesCanisterExist"><span class="hs-identifier hs-type">doesCanisterExist</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336896"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336896"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-102"></span><span id="doesCanisterExist"><span class="annot"><span class="annottext">doesCanisterExist :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#doesCanisterExist"><span class="hs-identifier hs-var hs-var">doesCanisterExist</span></a></span></span><span> </span><span id="local-6989586621679336492"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336492"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-103"></span><span>  </span><span class="annot"><span class="annottext">(IC -&gt; Maybe CanState) -&gt; m (Maybe CanState)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId -&gt; Map CanisterId CanState -&gt; Maybe CanState
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336492"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">(Map CanisterId CanState -&gt; Maybe CanState)
-&gt; (IC -&gt; Map CanisterId CanState) -&gt; IC -&gt; Maybe CanState
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Maybe CanState) -&gt; (Maybe CanState -&gt; m Bool) -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-104"></span><span>    </span><span class="annot"><span class="annottext">Maybe CanState
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-105"></span><span>    </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-106"></span><span>    </span><span class="annot"><span class="annottext">Maybe CanState
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-107"></span><span>
</span><span id="line-108"></span><span id="local-6989586621679336485"><span class="annot"><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-type">isCanisterRunning</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336485"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336485"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-109"></span><span id="isCanisterRunning"><span class="annot"><span class="annottext">isCanisterRunning :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var hs-var">isCanisterRunning</span></a></span></span><span> </span><span id="local-6989586621679336468"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336468"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m RunStatus
</span><a href="IC.Ref.Types.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336468"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; m Bool) -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-110"></span><span>    </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-111"></span><span>    </span><span class="annot"><span class="annottext">RunStatus
</span><span class="hs-identifier">_</span></span><span>         </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-112"></span><span>
</span><span id="line-113"></span><span class="hs-comment">-- Authentication and authorization of requests</span><span>
</span><span id="line-114"></span><span class="hs-comment">--</span><span>
</span><span id="line-115"></span><span class="hs-comment">-- The envelope has already been validated. So this includes</span><span>
</span><span id="line-116"></span><span class="hs-comment">--  * Comparing the envelope validity with the contents</span><span>
</span><span id="line-117"></span><span class="hs-comment">--  * Authorization of the sender</span><span>
</span><span id="line-118"></span><span class="hs-comment">--  * ingress message inspection</span><span>
</span><span id="line-119"></span><span class="hs-comment">--  * checking the correct effective id</span><span>
</span><span id="line-120"></span><span>
</span><span id="line-121"></span><span class="hs-keyword">type</span><span> </span><span id="RequestValidation"><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-var">RequestValidation</span></a></span></span><span> </span><span id="local-6989586621679336465"><span class="annot"><a href="#local-6989586621679336465"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#MonadError"><span class="hs-identifier hs-type">MonadError</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">T.Text</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336465"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336465"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-122"></span><span>
</span><span id="line-123"></span><span id="local-6989586621679336876"><span class="annot"><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier hs-type">authCallRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336876"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-124"></span><span id="authCallRequest"><span class="annot"><span class="annottext">authCallRequest :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
Timestamp -&gt; CanisterId -&gt; EnvValidity -&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#authCallRequest"><span class="hs-identifier hs-var hs-var">authCallRequest</span></a></span></span><span> </span><span id="local-6989586621679336438"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336438"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679336437"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336437"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679336436"><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336436"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span id="local-6989586621679336435"><span class="annot"><span class="annottext">r :: CallRequest
</span><a href="#local-6989586621679336435"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679336434"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336434"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679336433"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336433"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679336432"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336432"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span id="local-6989586621679336431"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336431"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-125"></span><span>    </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; MethodName -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; MethodName -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var">checkEffectiveCanisterID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336437"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336434"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336432"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336431"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-126"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred Timestamp
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336436"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336438"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-127"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336436"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336433"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-128"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336436"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336434"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-129"></span><span>    </span><span class="annot"><span class="annottext">CallRequest -&gt; m ()
forall (m :: * -&gt; *). RequestValidation m =&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-var">inspectIngress</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679336435"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-130"></span><span>
</span><span id="line-131"></span><span id="local-6989586621679336863"><span class="annot"><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier hs-type">authQueryRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336863"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336863"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-132"></span><span id="authQueryRequest"><span class="annot"><span class="annottext">authQueryRequest :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
Timestamp -&gt; CanisterId -&gt; EnvValidity -&gt; QueryRequest -&gt; m ()
</span><a href="IC.Ref.html#authQueryRequest"><span class="hs-identifier hs-var hs-var">authQueryRequest</span></a></span></span><span> </span><span id="local-6989586621679336407"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336407"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679336406"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336406"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679336405"><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336405"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span id="local-6989586621679336403"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336403"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679336402"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336402"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679336401"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336401"><span class="hs-identifier hs-var">meth</span></a></span></span><span> </span><span id="local-6989586621679336400"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336400"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-133"></span><span>    </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; MethodName -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; MethodName -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var">checkEffectiveCanisterID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336406"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336403"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336401"><span class="hs-identifier hs-var">meth</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336400"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-134"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred Timestamp
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336405"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336407"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-135"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336405"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336402"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-136"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336405"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336403"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-137"></span><span>
</span><span id="line-138"></span><span id="local-6989586621679336860"><span class="annot"><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier hs-type">authReadStateRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336860"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#EnvValidity"><span class="hs-identifier hs-type">EnvValidity</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336860"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-139"></span><span id="authReadStateRequest"><span class="annot"><span class="annottext">authReadStateRequest :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
Timestamp -&gt; CanisterId -&gt; EnvValidity -&gt; ReadStateRequest -&gt; m ()
</span><a href="IC.Ref.html#authReadStateRequest"><span class="hs-identifier hs-var hs-var">authReadStateRequest</span></a></span></span><span> </span><span id="local-6989586621679336287"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336287"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679336286"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679336285"><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336285"><span class="hs-identifier hs-var">ev</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span id="local-6989586621679336283"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336283"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679336282"><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679336282"><span class="hs-identifier hs-var">paths</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-140"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred Timestamp
</span><a href="IC.Types.html#valid_when"><span class="hs-identifier hs-var hs-var">valid_when</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336285"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336287"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-141"></span><span>    </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_for"><span class="hs-identifier hs-var hs-var">valid_for</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336285"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336283"><span class="hs-identifier hs-var">user_id</span></a></span><span>
</span><span id="line-142"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679336281"><span class="annot"><span class="annottext">request_ids :: Path
</span><a href="#local-6989586621679336281"><span class="hs-identifier hs-var hs-var">request_ids</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Path -&gt; Path
forall a. Eq a =&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.OldList.html#nub"><span class="hs-identifier hs-var">nub</span></a></span><span> </span><span class="annot"><span class="annottext">(Path -&gt; Path) -&gt; Path -&gt; Path
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">[Path] -&gt; Path
forall (t :: * -&gt; *) a. Foldable t =&gt; t [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#concat"><span class="hs-identifier hs-var">concat</span></a></span><span> </span><span class="annot"><span class="annottext">([Path] -&gt; Path) -&gt; [Path] -&gt; Path
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(Path -&gt; Path) -&gt; [Path] -&gt; [Path]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">Path -&gt; Path
</span><a href="#local-6989586621679336278"><span class="hs-identifier hs-var">request_id</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679336282"><span class="hs-identifier hs-var">paths</span></a></span><span>
</span><span id="line-143"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Path -&gt; CallId
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; CallId
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#length"><span class="hs-identifier hs-var">length</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><a href="#local-6989586621679336281"><span class="hs-identifier hs-var">request_ids</span></a></span><span> </span><span class="annot"><span class="annottext">CallId -&gt; CallId -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><span class="hs-number">1</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-144"></span><span>      </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Can only request one request ID in request_status paths.&quot;</span></span><span>
</span><span id="line-145"></span><span>    </span><span class="hs-comment">-- Implement ACL for read requests here</span><span>
</span><span id="line-146"></span><span>    </span><span class="annot"><span class="annottext">[Path] -&gt; (Path -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679336282"><span class="hs-identifier hs-var">paths</span></a></span><span> </span><span class="annot"><span class="annottext">((Path -&gt; m ()) -&gt; m ()) -&gt; (Path -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-147"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-148"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;subnet&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-149"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679336272"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336272"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;module_hash&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-150"></span><span>        </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; CanisterId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336272"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-151"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679336269"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336269"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;controllers&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-152"></span><span>        </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; CanisterId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336269"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-153"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679336268"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336268"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;metadata&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679336267"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336267"><span class="hs-identifier hs-var">name</span></a></span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-154"></span><span>        </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; CanisterId
</span><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-var">EntityId</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336268"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-155"></span><span>        </span><span id="local-6989586621679336266"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679336266"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Maybe Text
</span><a href="IC.Utils.html#fromUtf8"><span class="hs-identifier hs-var">fromUtf8</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336267"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-156"></span><span>            </span><span class="annot"><span class="annottext">Maybe Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m Text
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Invalid utf8 in metadata path&quot;</span></span><span>
</span><span id="line-157"></span><span>            </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679336264"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679336264"><span class="hs-identifier hs-var">name</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m Text
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679336264"><span class="hs-identifier hs-var">name</span></a></span><span>
</span><span id="line-158"></span><span>        </span><span id="local-6989586621679336263"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679336263"><span class="hs-identifier hs-var">ex</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#doesCanisterExist"><span class="hs-identifier hs-var">doesCanisterExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-159"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679336263"><span class="hs-identifier hs-var">ex</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-160"></span><span>          </span><span id="local-6989586621679336261"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679336261"><span class="hs-identifier hs-var">mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-161"></span><span>          </span><span id="local-6989586621679336259"><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679336259"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m (Set CanisterId)
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m (Set CanisterId)
</span><a href="IC.Ref.Types.html#getControllers"><span class="hs-identifier hs-var">getControllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-162"></span><span>          </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Map Text (Bool, Blob) -&gt; Maybe (Bool, Blob)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679336266"><span class="hs-identifier hs-var">name</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Map Text (Bool, Blob)
</span><a href="IC.Canister.html#metadata"><span class="hs-identifier hs-var hs-var">metadata</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679336261"><span class="hs-identifier hs-var">mod</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-163"></span><span>            </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-comment">-- private</span><span>
</span><span id="line-164"></span><span>              </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId -&gt; Set CanisterId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Set.Internal.html#member"><span class="hs-identifier hs-var">S.member</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336283"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679336259"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-165"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;User is not authorized to read this metadata field&quot;</span></span><span>
</span><span id="line-166"></span><span>            </span><span class="annot"><span class="annottext">Maybe (Bool, Blob)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- public or absent</span><span>
</span><span id="line-167"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679336255"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336255"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Int64
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/bytestring-0.10.12.1/src/Data.ByteString.Lazy.html#length"><span class="hs-identifier hs-var">BS.length</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336255"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">Int64 -&gt; Int64 -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Int64
</span><span class="hs-number">32</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Request IDs must be 32 bytes in length.&quot;</span></span><span>
</span><span id="line-168"></span><span>      </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679336252"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336252"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>                            </span><span>
</span><span id="line-169"></span><span>        </span><span class="annot"><span class="annottext">(IC -&gt; Maybe (CallRequest, (RequestStatus, CanisterId)))
-&gt; m (Maybe (CallRequest, (RequestStatus, CanisterId)))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; IC -&gt; Maybe (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.html#findRequest"><span class="hs-identifier hs-var">findRequest</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336252"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">m (Maybe (CallRequest, (RequestStatus, CanisterId)))
-&gt; (Maybe (CallRequest, (RequestStatus, CanisterId)) -&gt; m ())
-&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-170"></span><span>          </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679336251"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679336251"><span class="hs-identifier hs-var">ar</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679336250"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336250"><span class="hs-identifier hs-var">ecid'</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-171"></span><span>            </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336286"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336250"><span class="hs-identifier hs-var">ecid'</span></a></span><span>
</span><span id="line-172"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336283"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest -&gt; CanisterId
</span><a href="IC.Ref.Types.html#callerOfCallRequest"><span class="hs-identifier hs-var">callerOfCallRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679336251"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-173"></span><span>              </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;User is not authorized to read this request status&quot;</span></span><span>
</span><span id="line-174"></span><span>            </span><span class="annot"><span class="annottext">EnvValidity -&gt; ValidityPred CanisterId
</span><a href="IC.Types.html#valid_where"><span class="hs-identifier hs-var hs-var">valid_where</span></a></span><span> </span><span class="annot"><span class="annottext">EnvValidity
</span><a href="#local-6989586621679336285"><span class="hs-identifier hs-var">ev</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest -&gt; CanisterId
</span><a href="IC.Ref.html#calleeOfCallRequest"><span class="hs-identifier hs-var">calleeOfCallRequest</span></a></span><span> </span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679336251"><span class="hs-identifier hs-var">ar</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-175"></span><span>          </span><span class="annot"><span class="annottext">Maybe (CallRequest, (RequestStatus, CanisterId))
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-176"></span><span>      </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;User is not authorized to read unspecified state paths&quot;</span></span><span>
</span><span id="line-177"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-178"></span><span>    </span><span class="annot"><a href="#local-6989586621679336278"><span class="hs-identifier hs-type">request_id</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.HashTree.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.HashTree.html#Label"><span class="hs-identifier hs-type">Label</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-179"></span><span>    </span><span id="local-6989586621679336278"><span class="annot"><span class="annottext">request_id :: Path -&gt; Path
</span><a href="#local-6989586621679336278"><span class="hs-identifier hs-var hs-var">request_id</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span id="local-6989586621679336248"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336248"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-type">:</span></a></span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336248"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-180"></span><span>    </span><span class="annot"><a href="#local-6989586621679336278"><span class="hs-identifier hs-var">request_id</span></a></span><span> </span><span class="annot"><span class="annottext">Path
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-181"></span><span>
</span><span id="line-182"></span><span class="hs-comment">-- Synchronous requests</span><span>
</span><span id="line-183"></span><span>
</span><span id="line-184"></span><span id="local-6989586621679336832"><span class="annot"><a href="IC.Ref.html#handleQuery"><span class="hs-identifier hs-type">handleQuery</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336832"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336832"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span></span><span>
</span><span id="line-185"></span><span id="handleQuery"><span class="annot"><span class="annottext">handleQuery :: forall (m :: * -&gt; *).
ICM m =&gt;
Timestamp -&gt; QueryRequest -&gt; m ReqResponse
</span><a href="IC.Ref.html#handleQuery"><span class="hs-identifier hs-var hs-var">handleQuery</span></a></span></span><span> </span><span id="local-6989586621679336233"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336233"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#QueryRequest"><span class="hs-identifier hs-type">QueryRequest</span></a></span><span> </span><span id="local-6989586621679336232"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679336231"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336231"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679336230"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336230"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679336229"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336229"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-186"></span><span>  </span><span class="annot"><span class="annottext">(CallResponse -&gt; ReqResponse) -&gt; m CallResponse -&gt; m ReqResponse
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#fmap"><span class="hs-identifier hs-var">fmap</span></a></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; ReqResponse
</span><a href="IC.Ref.Types.html#QueryResponse"><span class="hs-identifier hs-var">QueryResponse</span></a></span><span> </span><span class="annot"><span class="annottext">(m CallResponse -&gt; m ReqResponse)
-&gt; m CallResponse -&gt; m ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((RejectCode, MethodName, Maybe ErrorCode) -&gt; m CallResponse)
-&gt; (forall (m' :: * -&gt; *).
    (CanReject m', ICM m') =&gt;
    m' CallResponse)
-&gt; m CallResponse
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, MethodName, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallResponse -&gt; m CallResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; m CallResponse)
-&gt; ((RejectCode, MethodName, Maybe ErrorCode) -&gt; CallResponse)
-&gt; (RejectCode, MethodName, Maybe ErrorCode)
-&gt; m CallResponse
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, MethodName, Maybe ErrorCode) -&gt; CallResponse
</span><a href="IC.Ref.Types.html#canisterRejected"><span class="hs-identifier hs-var">canisterRejected</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' CallResponse)
 -&gt; m CallResponse)
-&gt; (forall (m' :: * -&gt; *).
    (CanReject m', ICM m') =&gt;
    m' CallResponse)
-&gt; m CallResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-187"></span><span>    </span><span class="annot"><span class="annottext">CanisterId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-188"></span><span>    </span><span id="local-6989586621679336166"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679336166"><span class="hs-identifier hs-var">is_running</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var">isCanisterRunning</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-189"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m' () -&gt; m' ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679336166"><span class="hs-identifier hs-var">is_running</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m' () -&gt; m' ()) -&gt; m' () -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;canister is stopped&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_STOPPED"><span class="hs-identifier hs-var">EC_CANISTER_STOPPED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-190"></span><span>    </span><span id="local-6989586621679336161"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679336161"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-191"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m' () -&gt; m' ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679336161"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m' () -&gt; m' ()) -&gt; m' () -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;canister is empty&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_EMPTY"><span class="hs-identifier hs-var">EC_CANISTER_EMPTY</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-192"></span><span>    </span><span id="local-6989586621679336157"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679336157"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' WasmState
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m WasmState
</span><a href="IC.Ref.Types.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-193"></span><span>    </span><span id="local-6989586621679336155"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679336155"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-194"></span><span>    </span><span id="local-6989586621679336154"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336154"><span class="hs-identifier hs-var">certificate</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; CanisterId -&gt; m' Blob
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; m Blob
</span><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-var">getDataCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336233"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-195"></span><span>    </span><span id="local-6989586621679336152"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679336152"><span class="hs-identifier hs-var">env0</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' Env
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Env
</span><a href="IC.Ref.Types.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336232"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-196"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679336150"><span class="annot"><span class="annottext">env :: Env
</span><a href="#local-6989586621679336150"><span class="hs-identifier hs-var hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679336152"><span class="hs-identifier hs-var">env0</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">env_certificate :: Maybe Blob
</span><a href="IC.Types.html#env_certificate"><span class="hs-identifier hs-var">env_certificate</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Maybe Blob
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336154"><span class="hs-identifier hs-var">certificate</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-197"></span><span>
</span><span id="line-198"></span><span>    </span><span id="local-6989586621679336148"><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679336148"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; m' (Maybe (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodName
-&gt; Map MethodName (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; Maybe (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336230"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule
-&gt; Map MethodName (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
</span><a href="IC.Canister.html#query_methods"><span class="hs-identifier hs-var hs-var">query_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679336155"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-199"></span><span>      </span><span class="annot"><span class="annottext">m' (Maybe (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc))
-&gt; m' (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; m' (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall (m :: * -&gt; *) a. Monad m =&gt; m (Maybe a) -&gt; m a -&gt; m a
</span><a href="IC.Ref.Types.html#orElse"><span class="hs-operator hs-var">`orElse`</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
-&gt; MethodName
-&gt; Maybe ErrorCode
-&gt; m' (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;query method does not exist&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_METHOD_NOT_FOUND"><span class="hs-identifier hs-var">EC_METHOD_NOT_FOUND</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-200"></span><span>
</span><span id="line-201"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679336148"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336231"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679336150"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336229"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679336157"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-202"></span><span>      </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679336143"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336143"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m' CallResponse
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;canister trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; MethodName -&gt; MethodName
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336143"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_TRAPPED"><span class="hs-identifier hs-var">EC_CANISTER_TRAPPED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-203"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679336139"><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679336139"><span class="hs-identifier hs-var">rc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679336138"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336138"><span class="hs-identifier hs-var">rm</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m' CallResponse
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679336139"><span class="hs-identifier hs-var">rc</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336138"><span class="hs-identifier hs-var">rm</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_REJECTED"><span class="hs-identifier hs-var">EC_CANISTER_REJECTED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-204"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679336135"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336135"><span class="hs-identifier hs-var">res</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; m' CallResponse
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; m' CallResponse)
-&gt; CallResponse -&gt; m' CallResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CallResponse
</span><a href="IC.Ref.Types.html#Replied"><span class="hs-identifier hs-var">Replied</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336135"><span class="hs-identifier hs-var">res</span></a></span><span>
</span><span id="line-205"></span><span>
</span><span id="line-206"></span><span id="local-6989586621679336802"><span class="annot"><a href="IC.Ref.html#handleReadState"><span class="hs-identifier hs-type">handleReadState</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336802"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336802"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Either.html#Either"><span class="hs-identifier hs-type">Either</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">T.Text</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ReqResponse"><span class="hs-identifier hs-type">ReqResponse</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-207"></span><span id="handleReadState"><span class="annot"><span class="annottext">handleReadState :: forall (m :: * -&gt; *).
ICM m =&gt;
Timestamp
-&gt; CanisterId -&gt; ReadStateRequest -&gt; m (Either Text ReqResponse)
</span><a href="IC.Ref.html#handleReadState"><span class="hs-identifier hs-var hs-var">handleReadState</span></a></span></span><span> </span><span id="local-6989586621679336123"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336123"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679336122"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336122"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#ReadStateRequest"><span class="hs-identifier hs-type">ReadStateRequest</span></a></span><span> </span><span id="local-6989586621679336121"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336121"><span class="hs-identifier hs-var">_sender</span></a></span></span><span> </span><span id="local-6989586621679336120"><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679336120"><span class="hs-identifier hs-var">paths</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((RejectCode, MethodName, Maybe ErrorCode)
 -&gt; m (Either Text ReqResponse))
-&gt; (forall (m' :: * -&gt; *).
    (CanReject m', ICM m') =&gt;
    m' (Either Text ReqResponse))
-&gt; m (Either Text ReqResponse)
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, MethodName, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679336119"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336119"><span class="hs-identifier hs-var">s</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ErrorCode
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Either Text ReqResponse -&gt; m (Either Text ReqResponse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Text ReqResponse -&gt; m (Either Text ReqResponse))
-&gt; Either Text ReqResponse -&gt; m (Either Text ReqResponse)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Either Text ReqResponse
forall a b. a -&gt; Either a b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-var">Left</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; Either Text ReqResponse)
-&gt; Text -&gt; Either Text ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336119"><span class="hs-identifier hs-var">s</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *).
  (CanReject m', ICM m') =&gt;
  m' (Either Text ReqResponse))
 -&gt; m (Either Text ReqResponse))
-&gt; (forall (m' :: * -&gt; *).
    (CanReject m', ICM m') =&gt;
    m' (Either Text ReqResponse))
-&gt; m (Either Text ReqResponse)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-208"></span><span>    </span><span class="hs-comment">-- NB: Already authorized in authSyncRequest</span><span>
</span><span id="line-209"></span><span>    </span><span id="local-6989586621679336103"><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679336103"><span class="hs-identifier hs-var">cert</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m' Certificate
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var">getPrunedCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679336123"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336122"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Path -&gt; [Path] -&gt; [Path]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679336120"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-210"></span><span>    </span><span class="annot"><span class="annottext">Either Text ReqResponse -&gt; m' (Either Text ReqResponse)
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Either Text ReqResponse -&gt; m' (Either Text ReqResponse))
-&gt; Either Text ReqResponse -&gt; m' (Either Text ReqResponse)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ReqResponse -&gt; Either Text ReqResponse
forall a b. b -&gt; Either a b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-var">Right</span></a></span><span> </span><span class="annot"><span class="annottext">(ReqResponse -&gt; Either Text ReqResponse)
-&gt; ReqResponse -&gt; Either Text ReqResponse
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate -&gt; ReqResponse
</span><a href="IC.Ref.Types.html#ReadStateResponse"><span class="hs-identifier hs-var">ReadStateResponse</span></a></span><span> </span><span class="annot"><span class="annottext">Certificate
</span><a href="#local-6989586621679336103"><span class="hs-identifier hs-var">cert</span></a></span><span>
</span><span id="line-211"></span><span>
</span><span id="line-212"></span><span id="local-6989586621679336866"><span class="annot"><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-type">checkEffectiveCanisterID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#MethodName"><span class="hs-identifier hs-type">MethodName</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336866"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-213"></span><span id="checkEffectiveCanisterID"><span class="annot"><span class="annottext">checkEffectiveCanisterID :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; MethodName -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.html#checkEffectiveCanisterID"><span class="hs-identifier hs-var hs-var">checkEffectiveCanisterID</span></a></span></span><span> </span><span id="local-6989586621679336004"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336004"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679336003"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336003"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span id="local-6989586621679336002"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336002"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679336001"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336001"><span class="hs-identifier hs-var">arg</span></a></span></span><span>
</span><span id="line-214"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336003"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="IC.Ref.Types.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-215"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336002"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; MethodName -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (f :: * -&gt; *) a. Applicative f =&gt; a -&gt; f a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#pure"><span class="hs-identifier hs-var">pure</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-216"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336002"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; [MethodName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;create_canister&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;raw_rand&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;http_request&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;ecdsa_public_key&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;sign_with_ecdsa&quot;</span></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-217"></span><span>         </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679336002"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span>  </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; cannot be invoked via ingress calls&quot;</span></span><span>
</span><span id="line-218"></span><span>       </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. CandidArg a =&gt; Blob -&gt; Either MethodName a
</span><a href="file:///nix/store/5q8knwbpcq1xjhfifih1jfwmvd2jr0sg-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Class.html#decode"><span class="hs-identifier hs-var">Codec.Candid.decode</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#Rec"><span class="hs-identifier hs-type">R.Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Internal.html#.%3D%3D"><span class="hs-operator hs-type">R..==</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/5q8knwbpcq1xjhfifih1jfwmvd2jr0sg-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Data.html#Principal"><span class="hs-identifier hs-type">Principal</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679336001"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-219"></span><span>                        </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679335997"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335997"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-220"></span><span>                          </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;call to management canister is not valid candid: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335997"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-221"></span><span>                        </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679335996"><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679335996"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-222"></span><span>                          </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336004"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Principal -&gt; CanisterId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679335996"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#.%21"><span class="hs-operator hs-var">.!</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679336069"><span class="hs-var">#canister_id</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-223"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; m ()
forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var">assertEffectiveCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336004"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679336003"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-224"></span><span>
</span><span id="line-225"></span><span id="local-6989586621679336842"><span class="annot"><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-type">assertEffectiveCanisterId</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336842"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336842"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-226"></span><span id="assertEffectiveCanisterId"><span class="annot"><span class="annottext">assertEffectiveCanisterId :: forall (m :: * -&gt; *).
RequestValidation m =&gt;
CanisterId -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#assertEffectiveCanisterId"><span class="hs-identifier hs-var hs-var">assertEffectiveCanisterId</span></a></span></span><span> </span><span id="local-6989586621679335982"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335982"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679335981"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335981"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-227"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335982"><span class="hs-identifier hs-var">ecid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335981"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-228"></span><span>    </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;expected effective canister_id &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId -&gt; MethodName
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335981"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;, got &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId -&gt; MethodName
</span><a href="IC.Types.html#prettyID"><span class="hs-identifier hs-var">prettyID</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335982"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-229"></span><span>
</span><span id="line-230"></span><span id="local-6989586621679336864"><span class="annot"><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-type">inspectIngress</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.html#RequestValidation"><span class="hs-identifier hs-type">RequestValidation</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336864"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336864"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-231"></span><span id="inspectIngress"><span class="annot"><span class="annottext">inspectIngress :: forall (m :: * -&gt; *). RequestValidation m =&gt; CallRequest -&gt; m ()
</span><a href="IC.Ref.html#inspectIngress"><span class="hs-identifier hs-var hs-var">inspectIngress</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679335854"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335854"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679335853"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335853"><span class="hs-identifier hs-var">user_id</span></a></span></span><span> </span><span id="local-6989586621679335852"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335852"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679335851"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335851"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">)</span><span>
</span><span id="line-232"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335854"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="IC.Ref.Types.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-233"></span><span>    </span><span class="hs-keyword">if</span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335852"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; [MethodName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;provisional_create_canister_with_cycles&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;provisional_top_up_canister&quot;</span></span><span class="hs-special">]</span><span>
</span><span id="line-234"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-235"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335852"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; [MethodName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;raw_rand&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;deposit_cycles&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;http_request&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;ecdsa_public_key&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;sign_with_ecdsa&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-236"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Management method &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335852"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot; cannot be invoked via an ingress call&quot;</span></span><span>
</span><span id="line-237"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335852"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; [MethodName] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span> </span><span class="annot"><span class="annottext">[MethodName]
</span><a href="IC.Management.html#managementMethods"><span class="hs-identifier hs-var">managementMethods</span></a></span><span>
</span><span id="line-238"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">forall a. CandidArg a =&gt; Blob -&gt; Either MethodName a
</span><a href="file:///nix/store/5q8knwbpcq1xjhfifih1jfwmvd2jr0sg-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Class.html#decode"><span class="hs-identifier hs-var">decode</span></a></span><span> </span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#Rec"><span class="hs-identifier hs-type">R.Rec</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="hs-string">&quot;canister_id&quot;</span></span><span> </span><span class="annot"><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Internal.html#.%3D%3D"><span class="hs-operator hs-type">R..==</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/5q8knwbpcq1xjhfifih1jfwmvd2jr0sg-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Data.html#Principal"><span class="hs-identifier hs-type">Principal</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335851"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-239"></span><span>        </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Either.html#Left"><span class="hs-identifier hs-type">Left</span></a></span><span> </span><span id="local-6989586621679335849"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335849"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Candid failed to decode: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335849"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-240"></span><span>        </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Either.html#Right"><span class="hs-identifier hs-type">Right</span></a></span><span> </span><span id="local-6989586621679335848"><span class="annot"><span class="annottext">Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679335848"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-241"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335847"><span class="annot"><span class="annottext">canister_id :: CanisterId
</span><a href="#local-6989586621679335847"><span class="hs-identifier hs-var hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Principal -&gt; CanisterId
</span><a href="IC.Management.html#principalToEntityId"><span class="hs-identifier hs-var">principalToEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">(Principal -&gt; CanisterId) -&gt; Principal -&gt; CanisterId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
Rec (&quot;canister_id&quot; .== Principal)
</span><a href="#local-6989586621679335848"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Rec ('R '[ &quot;canister_id&quot; ':-&gt; Principal])
-&gt; Label &quot;canister_id&quot;
-&gt; 'R '[ &quot;canister_id&quot; ':-&gt; Principal] .! &quot;canister_id&quot;
forall (l :: Symbol) (r :: Row (*)).
KnownSymbol l =&gt;
Rec r -&gt; Label l -&gt; r .! l
</span><a href="file:///nix/store/b588wzszvp5fnvv6rhlb8hcvmljsxf2h-row-types-1.0.1.2-doc/share/doc/row-types-1.0.1.2/html/src/Data.Row.Records.html#.%21"><span class="hs-operator hs-var">.!</span></a></span><span> </span><span class="annot"><span class="annottext">IsLabel &quot;canister_id&quot; (Label &quot;canister_id&quot;)
Label &quot;canister_id&quot;
</span><a href="#local-6989586621679335947"><span class="hs-var">#canister_id</span></a></span><span>
</span><span id="line-242"></span><span>            </span><span class="annot"><span class="annottext">((RejectCode, MethodName, Maybe ErrorCode) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, MethodName, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ())
-&gt; ((RejectCode, MethodName, Maybe ErrorCode) -&gt; Text)
-&gt; (RejectCode, MethodName, Maybe ErrorCode)
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(MethodName -&gt; Text)
-&gt; ((RejectCode, MethodName, Maybe ErrorCode) -&gt; MethodName)
-&gt; (RejectCode, MethodName, Maybe ErrorCode)
-&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, MethodName, Maybe ErrorCode) -&gt; MethodName
</span><a href="IC.Ref.Types.html#rejectMessage"><span class="hs-identifier hs-var">rejectMessage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-243"></span><span>                </span><span class="annot"><span class="annottext">CanisterId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335847"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-244"></span><span>            </span><span id="local-6989586621679335835"><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679335835"><span class="hs-identifier hs-var">controllers</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m (Set CanisterId)
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m (Set CanisterId)
</span><a href="IC.Ref.Types.html#getControllers"><span class="hs-identifier hs-var">getControllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335847"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-245"></span><span>            </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335853"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Set CanisterId -&gt; Bool
forall a. Ord a =&gt; a -&gt; Set a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Set.Internal.html#member"><span class="hs-operator hs-var">`S.member`</span></a></span><span> </span><span class="annot"><span class="annottext">Set CanisterId
</span><a href="#local-6989586621679335835"><span class="hs-identifier hs-var">controllers</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-246"></span><span>                </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Wrong sender&quot;</span></span><span>
</span><span id="line-247"></span><span>      </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>
</span><span id="line-248"></span><span>      </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;Unknown management method &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335852"><span class="hs-identifier hs-var">method</span></a></span><span>
</span><span id="line-249"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-250"></span><span>    </span><span class="annot"><span class="annottext">((RejectCode, MethodName, Maybe ErrorCode) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, MethodName, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ())
-&gt; ((RejectCode, MethodName, Maybe ErrorCode) -&gt; Text)
-&gt; (RejectCode, MethodName, Maybe ErrorCode)
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(MethodName -&gt; Text)
-&gt; ((RejectCode, MethodName, Maybe ErrorCode) -&gt; MethodName)
-&gt; (RejectCode, MethodName, Maybe ErrorCode)
-&gt; Text
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, MethodName, Maybe ErrorCode) -&gt; MethodName
</span><a href="IC.Ref.Types.html#rejectMessage"><span class="hs-identifier hs-var">rejectMessage</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-251"></span><span>        </span><span class="annot"><span class="annottext">CanisterId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335854"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-252"></span><span>    </span><span id="local-6989586621679335824"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679335824"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335854"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-253"></span><span>    </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679335824"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;canister is empty&quot;</span></span><span>
</span><span id="line-254"></span><span>    </span><span id="local-6989586621679335823"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335823"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m WasmState
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m WasmState
</span><a href="IC.Ref.Types.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335854"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-255"></span><span>    </span><span id="local-6989586621679335822"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335822"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335854"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-256"></span><span>    </span><span id="local-6989586621679335821"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335821"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Env
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Env
</span><a href="IC.Ref.Types.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335854"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-257"></span><span>
</span><span id="line-258"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; MethodName
-&gt; CanisterId
-&gt; Env
-&gt; Blob
-&gt; WasmState
-&gt; TrapOr ()
</span><a href="IC.Canister.html#inspect_message"><span class="hs-identifier hs-var hs-var">inspect_message</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335822"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335852"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335853"><span class="hs-identifier hs-var">user_id</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335821"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335851"><span class="hs-identifier hs-var">arg</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335823"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-259"></span><span>      </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679335819"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335819"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Text -&gt; m ()
forall e (m :: * -&gt; *) a. MonadError e m =&gt; e -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.Error.Class.html#throwError"><span class="hs-identifier hs-var">throwError</span></a></span><span> </span><span class="annot"><span class="annottext">(Text -&gt; m ()) -&gt; Text -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;canister trapped in inspect_message: &quot;</span></span><span> </span><span class="annot"><span class="annottext">Text -&gt; Text -&gt; Text
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3C%3E"><span class="hs-operator hs-var">&lt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335819"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-260"></span><span>      </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-261"></span><span>
</span><span id="line-262"></span><span class="hs-comment">-- The state tree</span><span>
</span><span id="line-263"></span><span>
</span><span id="line-264"></span><span class="annot"><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-type">stateTree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span><span>
</span><span id="line-265"></span><span id="stateTree"><span class="annot"><span class="annottext">stateTree :: Timestamp -&gt; IC -&gt; LabeledTree
</span><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-var hs-var">stateTree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679335816"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335816"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679335815"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335815"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-266"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335816"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-267"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;subnet&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">((CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
 -&gt; Map Blob LabeledTree)
-&gt; [(CanisterId, SubnetType, Word64, SecretKey,
     [(Word64, Word64)])]
-&gt; [Map Blob LabeledTree]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
-&gt; Map Blob LabeledTree
forall {b} {c} {d}.
(CanisterId, b, c, d, [(Word64, Word64)]) -&gt; Map Blob LabeledTree
</span><a href="#local-6989586621679335811"><span class="hs-identifier hs-var">subnet_tree</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC
-&gt; [(CanisterId, SubnetType, Word64, SecretKey,
     [(Word64, Word64)])]
</span><a href="IC.Ref.Types.html#subnets"><span class="hs-identifier hs-var hs-var">subnets</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335815"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-268"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;request_status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-269"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335809"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679335808"><span class="hs-identifier hs-var">rs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-270"></span><span>        </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Received"><span class="hs-identifier hs-var">Received</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-271"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679335806"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;received&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-272"></span><span>        </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-273"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679335806"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;processing&quot;</span></span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-274"></span><span>        </span><span class="annot"><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#Replied"><span class="hs-identifier hs-type">Replied</span></a></span><span> </span><span id="local-6989586621679335803"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335803"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-275"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679335806"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;replied&quot;</span></span><span>
</span><span id="line-276"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;reply&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335803"><span class="hs-identifier hs-var">r</span></a></span><span>
</span><span id="line-277"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-278"></span><span>        </span><span class="annot"><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-type">CallResponse</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#Rejected"><span class="hs-identifier hs-type">Rejected</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335801"><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679335801"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335800"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335800"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335799"><span class="annot"><span class="annottext">Maybe ErrorCode
</span><a href="#local-6989586621679335799"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="annot"><span class="annottext">([Map Blob LabeledTree] -&gt; LabeledTree)
-&gt; [Map Blob LabeledTree] -&gt; LabeledTree
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-279"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;error_code&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">(MethodName -&gt; Text) -&gt; MethodName -&gt; Text
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; MethodName
</span><a href="IC.Types.html#errorCode"><span class="hs-identifier hs-var">errorCode</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679335797"><span class="hs-identifier hs-var">code</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679335797"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679335797"><span class="hs-identifier hs-var">code</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Maybe ErrorCode -&gt; [ErrorCode]
forall a. Maybe a -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Maybe.html#maybeToList"><span class="hs-identifier hs-var">maybeToList</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe ErrorCode
</span><a href="#local-6989586621679335799"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree]
-&gt; [Map Blob LabeledTree] -&gt; [Map Blob LabeledTree]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-280"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;status&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
</span><a href="#local-6989586621679335806"><span class="hs-identifier hs-var">str</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><span class="hs-string">&quot;rejected&quot;</span></span><span>
</span><span id="line-281"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;reject_code&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode -&gt; Natural
</span><a href="IC.Types.html#rejectCode"><span class="hs-identifier hs-var">rejectCode</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679335801"><span class="hs-identifier hs-var">c</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-282"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;reject_message&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Text -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodName -&gt; Text
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.html#pack"><span class="hs-identifier hs-var">T.pack</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335800"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-283"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-284"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335809"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335809"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335808"><span class="annot"><span class="annottext">RequestStatus
</span><a href="#local-6989586621679335808"><span class="hs-identifier hs-var">rs</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map Blob (CallRequest, (RequestStatus, CanisterId))
-&gt; [(Blob, (CallRequest, (RequestStatus, CanisterId)))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335815"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-285"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-286"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-287"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335793"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-288"></span><span>      </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;certified_data&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Blob
</span><a href="IC.Ref.Types.html#certified_data"><span class="hs-identifier hs-var hs-var">certified_data</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335791"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-289"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;controllers&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CanisterId] -&gt; Blob
</span><a href="IC.CBOR.Utils.html#encodePrincipalList"><span class="hs-identifier hs-var">encodePrincipalList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Set CanisterId -&gt; [CanisterId]
forall a. Set a -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Set.Internal.html#toList"><span class="hs-identifier hs-var">S.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanState -&gt; Set CanisterId
</span><a href="IC.Ref.Types.html#controllers"><span class="hs-identifier hs-var hs-var">controllers</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335791"><span class="hs-identifier hs-var">cs</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-290"></span><span>      </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree]
-&gt; [Map Blob LabeledTree] -&gt; [Map Blob LabeledTree]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-291"></span><span>      </span><span class="hs-special">(</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe CanisterContent
</span><a href="IC.Ref.Types.html#content"><span class="hs-identifier hs-var hs-var">content</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335791"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-292"></span><span>        </span><span class="annot"><span class="annottext">Maybe CanisterContent
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">]</span><span>
</span><span id="line-293"></span><span>        </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679335786"><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679335786"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-294"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;metadata&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-295"></span><span>            </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Text -&gt; Blob
</span><a href="IC.Utils.html#toUtf8"><span class="hs-identifier hs-var">toUtf8</span></a></span><span> </span><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679335784"><span class="hs-identifier hs-var">n</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335783"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335784"><span class="annot"><span class="annottext">Text
</span><a href="#local-6989586621679335784"><span class="hs-identifier hs-var">n</span></a></span></span><span class="hs-special">,</span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span id="local-6989586621679335783"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335783"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map Text (Bool, Blob) -&gt; [(Text, (Bool, Blob))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Map Text (Bool, Blob)
</span><a href="IC.Canister.html#metadata"><span class="hs-identifier hs-var hs-var">metadata</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterModule
</span><a href="IC.Ref.Types.html#can_mod"><span class="hs-identifier hs-var hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679335786"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-296"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;module_hash&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule -&gt; Blob
</span><a href="IC.Canister.html#raw_wasm_hash"><span class="hs-identifier hs-var hs-var">raw_wasm_hash</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterContent -&gt; CanisterModule
</span><a href="IC.Ref.Types.html#can_mod"><span class="hs-identifier hs-var hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterContent
</span><a href="#local-6989586621679335786"><span class="hs-identifier hs-var">cc</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-297"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-298"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-299"></span><span>    </span><span class="hs-special">)</span><span>
</span><span id="line-300"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679335793"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335793"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335791"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335791"><span class="hs-identifier hs-var">cs</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map CanisterId CanState -&gt; [(CanisterId, CanState)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335815"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-301"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var hs-var">run_status</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335791"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus -&gt; RunStatus -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span>
</span><span id="line-302"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-303"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-304"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-305"></span><span>    </span><span id="local-6989586621679335814"><span class="annot"><span class="annottext">node :: [Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Blob LabeledTree -&gt; LabeledTree
</span><a href="IC.HashTree.html#SubTrees"><span class="hs-identifier hs-var">SubTrees</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Blob LabeledTree -&gt; LabeledTree)
-&gt; ([Map Blob LabeledTree] -&gt; Map Blob LabeledTree)
-&gt; [Map Blob LabeledTree]
-&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; Map Blob LabeledTree
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span>
</span><span id="line-306"></span><span>    </span><span id="local-6989586621679336738"><span class="annot"><a href="#local-6989586621679335812"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html#CertVal"><span class="hs-identifier hs-type">CertVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336738"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336738"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span></span><span>
</span><span id="line-307"></span><span>    </span><span id="local-6989586621679335812"><span class="annot"><span class="annottext">val :: forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
</span><a href="IC.HashTree.html#Value"><span class="hs-identifier hs-var">Value</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; LabeledTree) -&gt; (a -&gt; Blob) -&gt; a -&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Blob
forall a. CertVal a =&gt; a -&gt; Blob
</span><a href="IC.Certificate.Value.html#toCertVal"><span class="hs-identifier hs-var">toCertVal</span></a></span><span>
</span><span id="line-308"></span><span>    </span><span id="local-6989586621679335806"><span class="annot"><span class="annottext">str :: Text -&gt; LabeledTree
</span><a href="#local-6989586621679335806"><span class="hs-identifier hs-var hs-var">str</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-glyph">@</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/text-1.2.5.0/src/Data.Text.Internal.html#Text"><span class="hs-identifier hs-type">T.Text</span></a></span><span>
</span><span id="line-309"></span><span>    </span><span id="local-6989586621679335813"><span class="annot"><span class="annottext">=: :: k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var hs-var">(=:)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; a -&gt; Map k a
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#singleton"><span class="hs-identifier hs-var">M.singleton</span></a></span><span>
</span><span id="line-310"></span><span>    </span><span id="local-6989586621679335811"><span class="annot"><span class="annottext">subnet_tree :: (CanisterId, b, c, d, [(Word64, Word64)]) -&gt; Map Blob LabeledTree
</span><a href="#local-6989586621679335811"><span class="hs-identifier hs-var hs-var">subnet_tree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679335766"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335766"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">b
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">c
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">d
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335765"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335765"><span class="hs-identifier hs-var">ranges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335766"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335814"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-311"></span><span>        </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;public_key&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335766"><span class="hs-identifier hs-var">subnet_id</span></a></span><span>
</span><span id="line-312"></span><span>        </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister_ranges&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335813"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335812"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CanisterRange] -&gt; Blob
</span><a href="IC.CBOR.Utils.html#encodeCanisterRangeList"><span class="hs-identifier hs-var">encodeCanisterRangeList</span></a></span><span> </span><span class="annot"><span class="annottext">([CanisterRange] -&gt; Blob) -&gt; [CanisterRange] -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((Word64, Word64) -&gt; CanisterRange)
-&gt; [(Word64, Word64)] -&gt; [CanisterRange]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679335763"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335763"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335762"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335762"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335763"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335762"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335765"><span class="hs-identifier hs-var">ranges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-313"></span><span>        </span><span class="hs-special">]</span><span>
</span><span id="line-314"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-315"></span><span>
</span><span id="line-316"></span><span class="annot"><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-type">delegationTree</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#SubnetId"><span class="hs-identifier hs-type">SubnetId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span><span>
</span><span id="line-317"></span><span id="delegationTree"><span class="annot"><span class="annottext">delegationTree :: Timestamp
-&gt; CanisterId -&gt; Blob -&gt; [(Word64, Word64)] -&gt; LabeledTree
</span><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-var hs-var">delegationTree</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679335758"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335758"><span class="hs-identifier hs-var">t</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#EntityId"><span class="hs-identifier hs-type">EntityId</span></a></span><span> </span><span id="local-6989586621679335757"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335757"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">)</span><span> </span><span id="local-6989586621679335756"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335756"><span class="hs-identifier hs-var">subnet_pub_key</span></a></span></span><span> </span><span id="local-6989586621679335755"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335755"><span class="hs-identifier hs-var">ranges</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335754"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-318"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335753"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335752"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335758"><span class="hs-identifier hs-var">t</span></a></span><span>
</span><span id="line-319"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;subnet&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335753"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335754"><span class="hs-identifier hs-var">node</span></a></span><span>
</span><span id="line-320"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335757"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335753"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335754"><span class="hs-identifier hs-var">node</span></a></span><span> </span><span class="hs-special">(</span><span>
</span><span id="line-321"></span><span>          </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;public_key&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335753"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335752"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335756"><span class="hs-identifier hs-var">subnet_pub_key</span></a></span><span>
</span><span id="line-322"></span><span>          </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister_ranges&quot;</span></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree -&gt; Map Blob LabeledTree
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335753"><span class="hs-operator hs-var">=:</span></a></span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335752"><span class="hs-identifier hs-var">val</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[CanisterRange] -&gt; Blob
</span><a href="IC.CBOR.Utils.html#encodeCanisterRangeList"><span class="hs-identifier hs-var">encodeCanisterRangeList</span></a></span><span> </span><span class="annot"><span class="annottext">([CanisterRange] -&gt; Blob) -&gt; [CanisterRange] -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">((Word64, Word64) -&gt; CanisterRange)
-&gt; [(Word64, Word64)] -&gt; [CanisterRange]
forall a b. (a -&gt; b) -&gt; [a] -&gt; [b]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#map"><span class="hs-identifier hs-var">map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679335751"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335751"><span class="hs-identifier hs-var">a</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335750"><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335750"><span class="hs-identifier hs-var">b</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335751"><span class="hs-identifier hs-var">a</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64 -&gt; CanisterId
</span><a href="IC.Id.Fresh.html#wordToId"><span class="hs-identifier hs-var">wordToId</span></a></span><span> </span><span class="annot"><span class="annottext">Word64
</span><a href="#local-6989586621679335750"><span class="hs-identifier hs-var">b</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335755"><span class="hs-identifier hs-var">ranges</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-323"></span><span>          </span><span class="hs-special">]</span><span>
</span><span id="line-324"></span><span>      </span><span class="hs-special">)</span><span>
</span><span id="line-325"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-326"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-327"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-328"></span><span>    </span><span id="local-6989586621679335754"><span class="annot"><span class="annottext">node :: [Map Blob LabeledTree] -&gt; LabeledTree
</span><a href="#local-6989586621679335754"><span class="hs-identifier hs-var hs-var">node</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map Blob LabeledTree -&gt; LabeledTree
</span><a href="IC.HashTree.html#SubTrees"><span class="hs-identifier hs-var">SubTrees</span></a></span><span> </span><span class="annot"><span class="annottext">(Map Blob LabeledTree -&gt; LabeledTree)
-&gt; ([Map Blob LabeledTree] -&gt; Map Blob LabeledTree)
-&gt; [Map Blob LabeledTree]
-&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">[Map Blob LabeledTree] -&gt; Map Blob LabeledTree
forall a. Monoid a =&gt; [a] -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#mconcat"><span class="hs-identifier hs-var">mconcat</span></a></span><span>
</span><span id="line-329"></span><span>    </span><span id="local-6989586621679335747"><span class="annot"><a href="#local-6989586621679335752"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Certificate.Value.html#CertVal"><span class="hs-identifier hs-type">CertVal</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679335747"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679335747"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#LabeledTree"><span class="hs-identifier hs-type">LabeledTree</span></a></span></span><span>
</span><span id="line-330"></span><span>    </span><span id="local-6989586621679335752"><span class="annot"><span class="annottext">val :: forall a. CertVal a =&gt; a -&gt; LabeledTree
</span><a href="#local-6989586621679335752"><span class="hs-identifier hs-var hs-var">val</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; LabeledTree
</span><a href="IC.HashTree.html#Value"><span class="hs-identifier hs-var">Value</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob -&gt; LabeledTree) -&gt; (a -&gt; Blob) -&gt; a -&gt; LabeledTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">a -&gt; Blob
forall a. CertVal a =&gt; a -&gt; Blob
</span><a href="IC.Certificate.Value.html#toCertVal"><span class="hs-identifier hs-var">toCertVal</span></a></span><span>
</span><span id="line-331"></span><span>    </span><span id="local-6989586621679335753"><span class="annot"><span class="annottext">=: :: k -&gt; a -&gt; Map k a
</span><a href="#local-6989586621679335753"><span class="hs-operator hs-var hs-var">(=:)</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">k -&gt; a -&gt; Map k a
forall {k} {a}. k -&gt; a -&gt; Map k a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#singleton"><span class="hs-identifier hs-var">M.singleton</span></a></span><span>
</span><span id="line-332"></span><span>
</span><span id="line-333"></span><span id="local-6989586621679336796"><span class="annot"><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-type">getPrunedCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336796"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336796"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.HashTree.html#Path"><span class="hs-identifier hs-type">Path</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336796"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span></span><span>
</span><span id="line-334"></span><span id="getPrunedCertificate"><span class="annot"><span class="annottext">getPrunedCertificate :: forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var hs-var">getPrunedCertificate</span></a></span></span><span> </span><span id="local-6989586621679335721"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335721"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679335720"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335720"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span id="local-6989586621679335719"><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679335719"><span class="hs-identifier hs-var">paths</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-335"></span><span>    </span><span id="local-6989586621679335718"><span class="annot"><span class="annottext">Maybe CanisterId
</span><a href="#local-6989586621679335718"><span class="hs-identifier hs-var">root_subnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe CanisterId) -&gt; m (Maybe CanisterId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Maybe CanisterId
</span><a href="IC.Ref.Types.html#rootSubnet"><span class="hs-identifier hs-var hs-var">rootSubnet</span></a></span><span>
</span><span id="line-336"></span><span>    </span><span id="local-6989586621679335716"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335716"><span class="hs-identifier hs-var">sk1</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; SecretKey) -&gt; m SecretKey
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; SecretKey
</span><a href="IC.Ref.Types.html#secretRootKey"><span class="hs-identifier hs-var hs-var">secretRootKey</span></a></span><span>
</span><span id="line-337"></span><span>    </span><span class="hs-special">(</span><span id="local-6989586621679335714"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335714"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SubnetType
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Word64
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335713"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335713"><span class="hs-identifier hs-var">sk2</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335712"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335712"><span class="hs-identifier hs-var">ranges</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId
-&gt; m (CanisterId, SubnetType, Word64, SecretKey,
      [(Word64, Word64)])
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
CanisterId
-&gt; m (CanisterId, SubnetType, Word64, SecretKey,
      [(Word64, Word64)])
</span><a href="IC.Ref.Types.html#getSubnetFromCanisterId"><span class="hs-identifier hs-var">getSubnetFromCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335720"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-338"></span><span>    </span><span id="local-6989586621679335710"><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679335710"><span class="hs-identifier hs-var">full_tree</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; HashTree) -&gt; m HashTree
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">LabeledTree -&gt; HashTree
</span><a href="IC.HashTree.html#construct"><span class="hs-identifier hs-var">construct</span></a></span><span> </span><span class="annot"><span class="annottext">(LabeledTree -&gt; HashTree) -&gt; (IC -&gt; LabeledTree) -&gt; IC -&gt; HashTree
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; IC -&gt; LabeledTree
</span><a href="IC.Ref.html#stateTree"><span class="hs-identifier hs-var">stateTree</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335721"><span class="hs-identifier hs-var">time</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-339"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335708"><span class="annot"><span class="annottext">cert_tree :: HashTree
</span><a href="#local-6989586621679335708"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">HashTree -&gt; [Path] -&gt; HashTree
</span><a href="IC.HashTree.html#prune"><span class="hs-identifier hs-var">prune</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679335710"><span class="hs-identifier hs-var">full_tree</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">Path -&gt; [Path] -&gt; [Path]
forall a. a -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#%3A"><span class="hs-glyph hs-var">:</span></a></span><span> </span><span class="annot"><span class="annottext">[Path]
</span><a href="#local-6989586621679335719"><span class="hs-identifier hs-var">paths</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-340"></span><span>    </span><span class="annot"><span class="annottext">Certificate -&gt; m Certificate
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(Certificate -&gt; m Certificate) -&gt; Certificate -&gt; m Certificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
-&gt; SecretKey
-&gt; Maybe (CanisterId, SecretKey, [(Word64, Word64)])
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335721"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335716"><span class="hs-identifier hs-var">sk1</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Maybe CanisterId
</span><a href="#local-6989586621679335718"><span class="hs-identifier hs-var">root_subnet</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe CanisterId -&gt; Maybe CanisterId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Maybe CanisterId
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335714"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">Maybe (CanisterId, SecretKey, [(Word64, Word64)])
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">(CanisterId, SecretKey, [(Word64, Word64)])
-&gt; Maybe (CanisterId, SecretKey, [(Word64, Word64)])
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335714"><span class="hs-identifier hs-var">subnet_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335713"><span class="hs-identifier hs-var">sk2</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335712"><span class="hs-identifier hs-var">ranges</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679335708"><span class="hs-identifier hs-var">cert_tree</span></a></span><span>
</span><span id="line-341"></span><span>
</span><span id="line-342"></span><span class="annot"><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-type">signCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#SubnetId"><span class="hs-identifier hs-type">SubnetId</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Crypto.html#SecretKey"><span class="hs-identifier hs-type">SecretKey</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Word.html#Word64"><span class="hs-identifier hs-type">W.Word64</span></a></span><span class="hs-special">)</span><span class="hs-special">]</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.HashTree.html#HashTree"><span class="hs-identifier hs-type">HashTree</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span>
</span><span id="line-343"></span><span id="signCertificate"><span class="annot"><span class="annottext">signCertificate :: Timestamp
-&gt; SecretKey
-&gt; Maybe (CanisterId, SecretKey, [(Word64, Word64)])
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var hs-var">signCertificate</span></a></span></span><span> </span><span id="local-6989586621679335705"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335705"><span class="hs-identifier hs-var">time</span></a></span></span><span> </span><span id="local-6989586621679335704"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335704"><span class="hs-identifier hs-var">rootKey</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335703"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335703"><span class="hs-identifier hs-var">subnet_id</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335702"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335702"><span class="hs-identifier hs-var">subnet_key</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335701"><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335701"><span class="hs-identifier hs-var">ranges</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span id="local-6989586621679335700"><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679335700"><span class="hs-identifier hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-344"></span><span>    </span><span class="annot"><span class="annottext">Certificate :: HashTree -&gt; Blob -&gt; Maybe Delegation -&gt; Certificate
</span><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashTree
cert_tree :: HashTree
cert_tree :: HashTree
</span><a href="IC.Certificate.html#cert_tree"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
cert_sig :: Blob
cert_sig :: Blob
</span><a href="IC.Certificate.html#cert_sig"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe Delegation
cert_delegation :: Maybe Delegation
cert_delegation :: Maybe Delegation
</span><a href="IC.Certificate.html#cert_delegation"><span class="hs-identifier hs-var hs-var">cert_delegation</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-345"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-346"></span><span>    </span><span id="local-6989586621679335697"><span class="annot"><span class="annottext">cert_sig :: Blob
</span><a href="#local-6989586621679335697"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; Blob
</span><a href="IC.Crypto.html#signPure"><span class="hs-identifier hs-var">signPure</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;ic-state-root&quot;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335702"><span class="hs-identifier hs-var">subnet_key</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashTree -&gt; Blob
</span><a href="IC.HashTree.html#reconstruct"><span class="hs-identifier hs-var">reconstruct</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679335700"><span class="hs-identifier hs-var">cert_tree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-347"></span><span>    </span><span id="local-6989586621679335695"><span class="annot"><span class="annottext">cert_delegation :: Maybe Delegation
</span><a href="#local-6989586621679335695"><span class="hs-identifier hs-var hs-var">cert_delegation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Delegation -&gt; Maybe Delegation
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(Delegation -&gt; Maybe Delegation) -&gt; Delegation -&gt; Maybe Delegation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Delegation :: Blob -&gt; Blob -&gt; Delegation
</span><a href="IC.Certificate.html#Delegation"><span class="hs-identifier hs-type">Delegation</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">Blob
del_subnet_id :: Blob
del_subnet_id :: Blob
</span><a href="IC.Certificate.html#del_subnet_id"><span class="hs-identifier hs-var hs-var">del_subnet_id</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
del_certificate :: Blob
del_certificate :: Blob
</span><a href="IC.Certificate.html#del_certificate"><span class="hs-identifier hs-var hs-var">del_certificate</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-348"></span><span>    </span><span id="local-6989586621679335690"><span class="annot"><span class="annottext">del_subnet_id :: Blob
</span><a href="#local-6989586621679335690"><span class="hs-identifier hs-var hs-var">del_subnet_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Blob
</span><a href="IC.Types.html#rawEntityId"><span class="hs-identifier hs-var hs-var">rawEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335703"><span class="hs-identifier hs-var">subnet_id</span></a></span><span>
</span><span id="line-349"></span><span>    </span><span id="local-6989586621679335688"><span class="annot"><span class="annottext">del_certificate :: Blob
</span><a href="#local-6989586621679335688"><span class="hs-identifier hs-var hs-var">del_certificate</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-350"></span><span>      </span><span class="annot"><span class="annottext">Certificate -&gt; Blob
</span><a href="IC.Certificate.CBOR.html#encodeCert"><span class="hs-identifier hs-var">encodeCert</span></a></span><span> </span><span class="annot"><span class="annottext">(Certificate -&gt; Blob) -&gt; Certificate -&gt; Blob
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-351"></span><span>      </span><span class="annot"><span class="annottext">Timestamp
-&gt; SecretKey
-&gt; Maybe (CanisterId, SecretKey, [(Word64, Word64)])
-&gt; HashTree
-&gt; Certificate
</span><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335705"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335704"><span class="hs-identifier hs-var">rootKey</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe (CanisterId, SecretKey, [(Word64, Word64)])
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="annot"><span class="annottext">(HashTree -&gt; Certificate) -&gt; HashTree -&gt; Certificate
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-352"></span><span>      </span><span class="annot"><span class="annottext">LabeledTree -&gt; HashTree
</span><a href="IC.HashTree.html#construct"><span class="hs-identifier hs-var">construct</span></a></span><span> </span><span class="annot"><span class="annottext">(LabeledTree -&gt; HashTree) -&gt; LabeledTree -&gt; HashTree
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-353"></span><span>      </span><span class="annot"><span class="annottext">Timestamp
-&gt; CanisterId -&gt; Blob -&gt; [(Word64, Word64)] -&gt; LabeledTree
</span><a href="IC.Ref.html#delegationTree"><span class="hs-identifier hs-var">delegationTree</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335705"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335703"><span class="hs-identifier hs-var">subnet_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">SecretKey -&gt; Blob
</span><a href="IC.Crypto.html#toPublicKey"><span class="hs-identifier hs-var">toPublicKey</span></a></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335702"><span class="hs-identifier hs-var">subnet_key</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[(Word64, Word64)]
</span><a href="#local-6989586621679335701"><span class="hs-identifier hs-var">ranges</span></a></span><span>
</span><span id="line-354"></span><span>
</span><span id="line-355"></span><span class="annot"><a href="IC.Ref.html#signCertificate"><span class="hs-identifier hs-var">signCertificate</span></a></span><span> </span><span id="local-6989586621679335683"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335683"><span class="hs-identifier hs-var">_time</span></a></span></span><span> </span><span id="local-6989586621679335682"><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335682"><span class="hs-identifier hs-var">rootKey</span></a></span></span><span> </span><span class="annot"><span class="annottext">Maybe (CanisterId, SecretKey, [(Word64, Word64)])
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span id="local-6989586621679335681"><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679335681"><span class="hs-identifier hs-var">cert_tree</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-356"></span><span>    </span><span class="annot"><span class="annottext">Certificate :: HashTree -&gt; Blob -&gt; Maybe Delegation -&gt; Certificate
</span><a href="IC.Certificate.html#Certificate"><span class="hs-identifier hs-type">Certificate</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">HashTree
cert_tree :: HashTree
cert_tree :: HashTree
</span><a href="#local-6989586621679335681"><span class="hs-identifier hs-var hs-var">cert_tree</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
cert_sig :: Blob
cert_sig :: Blob
</span><a href="#local-6989586621679335680"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">cert_delegation :: Maybe Delegation
</span><a href="IC.Certificate.html#cert_delegation"><span class="hs-identifier hs-var">cert_delegation</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe Delegation
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-357"></span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-358"></span><span>    </span><span id="local-6989586621679335680"><span class="annot"><span class="annottext">cert_sig :: Blob
</span><a href="#local-6989586621679335680"><span class="hs-identifier hs-var hs-var">cert_sig</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; SecretKey -&gt; Blob -&gt; Blob
</span><a href="IC.Crypto.html#signPure"><span class="hs-identifier hs-var">signPure</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;ic-state-root&quot;</span></span><span> </span><span class="annot"><span class="annottext">SecretKey
</span><a href="#local-6989586621679335682"><span class="hs-identifier hs-var">rootKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">HashTree -&gt; Blob
</span><a href="IC.HashTree.html#reconstruct"><span class="hs-identifier hs-var">reconstruct</span></a></span><span> </span><span class="annot"><span class="annottext">HashTree
</span><a href="#local-6989586621679335681"><span class="hs-identifier hs-var">cert_tree</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-359"></span><span>
</span><span id="line-360"></span><span class="hs-comment">-- If `stateTree` ever becomes a bottleneck:</span><span>
</span><span id="line-361"></span><span class="hs-comment">-- Since ic-ref creates a fresh state tree everytime it is used, we _could_</span><span>
</span><span id="line-362"></span><span class="hs-comment">-- construct one with just the required data, e.g. only of the canister in</span><span>
</span><span id="line-363"></span><span class="hs-comment">-- question. That would not be secure, but `ic-ref` doesn&#8217;t have to be.</span><span>
</span><span id="line-364"></span><span id="local-6989586621679336811"><span class="annot"><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-type">getDataCertificate</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336811"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336811"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336811"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#Blob"><span class="hs-identifier hs-type">Blob</span></a></span></span><span>
</span><span id="line-365"></span><span id="getDataCertificate"><span class="annot"><span class="annottext">getDataCertificate :: forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; m Blob
</span><a href="IC.Ref.html#getDataCertificate"><span class="hs-identifier hs-var hs-var">getDataCertificate</span></a></span></span><span> </span><span id="local-6989586621679335662"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335662"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span id="local-6989586621679335661"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335661"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-366"></span><span>    </span><span class="annot"><span class="annottext">Certificate -&gt; Blob
</span><a href="IC.Certificate.CBOR.html#encodeCert"><span class="hs-identifier hs-var">encodeCert</span></a></span><span> </span><span class="annot"><span class="annottext">(Certificate -&gt; Blob) -&gt; m Certificate -&gt; m Blob
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m Certificate
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
Timestamp -&gt; CanisterId -&gt; [Path] -&gt; m Certificate
</span><a href="IC.Ref.html#getPrunedCertificate"><span class="hs-identifier hs-var">getPrunedCertificate</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335662"><span class="hs-identifier hs-var">t</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335661"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-367"></span><span>        </span><span class="hs-special">[</span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;time&quot;</span></span><span class="hs-special">]</span><span class="hs-special">,</span><span> </span><span class="hs-special">[</span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;canister&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Blob
</span><a href="IC.Types.html#rawEntityId"><span class="hs-identifier hs-var hs-var">rawEntityId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335661"><span class="hs-identifier hs-var">cid</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Blob
</span><span class="hs-string">&quot;certified_data&quot;</span></span><span class="hs-special">]</span><span class="hs-special">]</span><span>
</span><span id="line-368"></span><span>
</span><span id="line-369"></span><span class="hs-comment">-- Asynchronous requests</span><span>
</span><span id="line-370"></span><span>
</span><span id="line-371"></span><span class="hs-comment">-- | Submission simply enqueues requests</span><span>
</span><span id="line-372"></span><span>
</span><span id="line-373"></span><span id="local-6989586621679336709"><span class="annot"><a href="IC.Ref.html#submitRequest"><span class="hs-identifier hs-type">submitRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336709"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336709"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-374"></span><span id="submitRequest"><span class="annot"><span class="annottext">submitRequest :: forall (m :: * -&gt; *).
ICM m =&gt;
Blob -&gt; CallRequest -&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#submitRequest"><span class="hs-identifier hs-var hs-var">submitRequest</span></a></span></span><span> </span><span id="local-6989586621679335654"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335654"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span id="local-6989586621679335653"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679335653"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679335652"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335652"><span class="hs-identifier hs-var">ecid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335651"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335651"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-375"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; Map Blob (CallRequest, (RequestStatus, CanisterId)) -&gt; Bool
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#member"><span class="hs-identifier hs-var">M.member</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335654"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335651"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-376"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335651"><span class="hs-identifier hs-var">ic</span></a></span><span>
</span><span id="line-377"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335651"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">requests :: Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var">requests</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob
-&gt; (CallRequest, (RequestStatus, CanisterId))
-&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
-&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">M.insert</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335654"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679335653"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Received"><span class="hs-identifier hs-var">Received</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335652"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335651"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-378"></span><span>
</span><span id="line-379"></span><span>
</span><span id="line-380"></span><span class="hs-comment">-- | Eventually, they are processed</span><span>
</span><span id="line-381"></span><span>
</span><span id="line-382"></span><span id="local-6989586621679336703"><span class="annot"><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-type">processRequest</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336703"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336703"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-383"></span><span id="processRequest"><span class="annot"><span class="annottext">processRequest :: forall (m :: * -&gt; *).
ICM m =&gt;
(Blob, CallRequest, CanisterId) -&gt; m ()
</span><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-var hs-var">processRequest</span></a></span></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335636"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335636"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span> </span><span id="local-6989586621679335635"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335635"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span id="local-6989586621679335634"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335634"><span class="hs-identifier hs-var">_user_id</span></a></span></span><span> </span><span id="local-6989586621679335633"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335633"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679335632"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335632"><span class="hs-identifier hs-var">arg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335631"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335631"><span class="hs-identifier hs-var">ecid</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-384"></span><span>  </span><span class="annot"><span class="annottext">((RejectCode, MethodName, Maybe ErrorCode) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, MethodName, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob -&gt; RequestStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335636"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">(RequestStatus -&gt; m ())
-&gt; ((RejectCode, MethodName, Maybe ErrorCode) -&gt; RequestStatus)
-&gt; (RejectCode, MethodName, Maybe ErrorCode)
-&gt; m ()
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; RequestStatus
</span><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; RequestStatus)
-&gt; ((RejectCode, MethodName, Maybe ErrorCode) -&gt; CallResponse)
-&gt; (RejectCode, MethodName, Maybe ErrorCode)
-&gt; RequestStatus
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">(RejectCode, MethodName, Maybe ErrorCode) -&gt; CallResponse
</span><a href="IC.Ref.Types.html#canisterRejected"><span class="hs-identifier hs-var">canisterRejected</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-385"></span><span>    </span><span id="local-6989586621679335610"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335610"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; m' CallId
forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; m' CallId) -&gt; CallContext -&gt; m' CallId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext :: CanisterId
-&gt; CallOrigin
-&gt; NeedsToRespond
-&gt; Bool
-&gt; Natural
-&gt; Maybe MethodName
-&gt; CallContext
</span><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-386"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335635"><span class="hs-identifier hs-var">canister_id</span></a></span><span>
</span><span id="line-387"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CanisterId -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#FromUser"><span class="hs-identifier hs-var">FromUser</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335636"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335631"><span class="hs-identifier hs-var">ecid</span></a></span><span>
</span><span id="line-388"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-389"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-390"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe MethodName
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe MethodName
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-391"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-392"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-393"></span><span>    </span><span class="annot"><span class="annottext">Message -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.Types.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m' ()) -&gt; Message -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallMessage :: CallId -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-394"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335610"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-395"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Blob -&gt; EntryPoint
</span><a href="IC.Ref.Types.html#Public"><span class="hs-identifier hs-var">Public</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335633"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335632"><span class="hs-identifier hs-var">arg</span></a></span><span>
</span><span id="line-396"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-397"></span><span>    </span><span class="annot"><span class="annottext">Blob -&gt; RequestStatus -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335636"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Processing"><span class="hs-identifier hs-var">Processing</span></a></span><span>
</span><span id="line-398"></span><span>
</span><span id="line-399"></span><span class="hs-comment">-- Call context handling</span><span>
</span><span id="line-400"></span><span>
</span><span id="line-401"></span><span id="local-6989586621679336699"><span class="annot"><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-type">newCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336699"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336699"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span></span><span>
</span><span id="line-402"></span><span id="newCallContext"><span class="annot"><span class="annottext">newCallContext :: forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var hs-var">newCallContext</span></a></span></span><span> </span><span id="local-6989586621679335590"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335590"><span class="hs-identifier hs-var">cc</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; (CallId, IC)) -&gt; m CallId
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; (CallId, IC)) -&gt; m CallId)
-&gt; (IC -&gt; (CallId, IC)) -&gt; m CallId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335588"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335588"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-403"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335587"><span class="annot"><span class="annottext">i :: CallId
</span><a href="#local-6989586621679335587"><span class="hs-identifier hs-var hs-var">i</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Map CallId CallContext -&gt; CallId
forall a. Map CallId a -&gt; CallId
</span><a href="IC.Utils.html#freshKey"><span class="hs-identifier hs-var">freshKey</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CallId CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335588"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-404"></span><span>  </span><span class="hs-keyword">in</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335587"><span class="hs-identifier hs-var">i</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335588"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_contexts :: Map CallId CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var">call_contexts</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
-&gt; CallContext -&gt; Map CallId CallContext -&gt; Map CallId CallContext
forall k a. Ord k =&gt; k -&gt; a -&gt; Map k a -&gt; Map k a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#insert"><span class="hs-identifier hs-var">M.insert</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335587"><span class="hs-identifier hs-var">i</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335590"><span class="hs-identifier hs-var">cc</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CallId CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335588"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-405"></span><span>
</span><span id="line-406"></span><span id="local-6989586621679336690"><span class="annot"><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-type">rememberTrap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336690"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#String"><span class="hs-identifier hs-type">String</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336690"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-407"></span><span id="rememberTrap"><span class="annot"><span class="annottext">rememberTrap :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; MethodName -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var hs-var">rememberTrap</span></a></span></span><span> </span><span id="local-6989586621679335575"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335575"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335574"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335574"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-408"></span><span>  </span><span class="annot"><span class="annottext">CallId -&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; (CallContext -&gt; CallContext) -&gt; m ()
</span><a href="IC.Ref.Types.html#modifyCallContext"><span class="hs-identifier hs-var">modifyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335575"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">((CallContext -&gt; CallContext) -&gt; m ())
-&gt; (CallContext -&gt; CallContext) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335572"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335572"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335572"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe MethodName
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Maybe MethodName
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335574"><span class="hs-identifier hs-var">msg</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-409"></span><span>
</span><span id="line-410"></span><span id="local-6989586621679336687"><span class="annot"><a href="IC.Ref.html#needsToRespondCallID"><span class="hs-identifier hs-type">needsToRespondCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336687"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336687"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-type">NeedsToRespond</span></a></span></span><span>
</span><span id="line-411"></span><span id="needsToRespondCallID"><span class="annot"><span class="annottext">needsToRespondCallID :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m NeedsToRespond
</span><a href="IC.Ref.html#needsToRespondCallID"><span class="hs-identifier hs-var hs-var">needsToRespondCallID</span></a></span></span><span> </span><span id="local-6989586621679335558"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335558"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var hs-var">needs_to_respond</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; NeedsToRespond)
-&gt; m CallContext -&gt; m NeedsToRespond
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335558"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-412"></span><span>
</span><span id="line-413"></span><span id="local-6989586621679336684"><span class="annot"><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-type">deletedCallID</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336684"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336684"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-414"></span><span id="deletedCallID"><span class="annot"><span class="annottext">deletedCallID :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Bool
</span><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-var hs-var">deletedCallID</span></a></span></span><span> </span><span id="local-6989586621679335543"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335543"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var hs-var">deleted</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; Bool) -&gt; m CallContext -&gt; m Bool
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Functor.html#%3C%24%3E"><span class="hs-operator hs-var">&lt;$&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335543"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-415"></span><span>
</span><span id="line-416"></span><span id="local-6989586621679336682"><span class="annot"><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-type">starveCallContext</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336682"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336682"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-417"></span><span id="starveCallContext"><span class="annot"><span class="annottext">starveCallContext :: forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m ()
</span><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-var hs-var">starveCallContext</span></a></span></span><span> </span><span id="local-6989586621679335525"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335525"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-418"></span><span>  </span><span id="local-6989586621679335524"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335524"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335525"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-419"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335523"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335523"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335522"><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679335522"><span class="hs-identifier hs-var">err</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679335521"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335521"><span class="hs-identifier hs-var">t</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; Maybe MethodName
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var hs-var">last_trap</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335524"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;canister trapped: &quot;</span></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; MethodName -&gt; MethodName
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335521"><span class="hs-identifier hs-var">t</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_TRAPPED"><span class="hs-identifier hs-var">EC_CANISTER_TRAPPED</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-420"></span><span>                 </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;canister did not respond&quot;</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_DID_NOT_REPLY"><span class="hs-identifier hs-var">EC_CANISTER_DID_NOT_REPLY</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-421"></span><span>  </span><span class="annot"><span class="annottext">CallId -&gt; (RejectCode, MethodName, Maybe ErrorCode) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; (RejectCode, MethodName, Maybe ErrorCode) -&gt; m ()
</span><a href="IC.Ref.Types.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335525"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335523"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="#local-6989586621679335522"><span class="hs-identifier hs-var">err</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-422"></span><span>
</span><span id="line-423"></span><span class="hs-comment">-- Message handling</span><span>
</span><span id="line-424"></span><span>
</span><span id="line-425"></span><span id="local-6989586621679335518"><span class="annot"><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-type">processMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679335518"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679335518"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-426"></span><span id="processMessage"><span class="annot"><span class="annottext">processMessage :: forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var hs-var">processMessage</span></a></span></span><span> </span><span id="local-6989586621679335473"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679335473"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679335473"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-427"></span><span>  </span><span class="annot"><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span> </span><span id="local-6989586621679335472"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335471"><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679335471"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">((RejectCode, MethodName, Maybe ErrorCode) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall (m :: * -&gt; *) b.
ICM m =&gt;
((RejectCode, MethodName, Maybe ErrorCode) -&gt; m b)
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' b) -&gt; m b
</span><a href="IC.Ref.Types.html#onReject"><span class="hs-identifier hs-var">onReject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallId -&gt; (RejectCode, MethodName, Maybe ErrorCode) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; (RejectCode, MethodName, Maybe ErrorCode) -&gt; m ()
</span><a href="IC.Ref.Types.html#rejectCallContext"><span class="hs-identifier hs-var">rejectCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">((forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ())
-&gt; (forall (m' :: * -&gt; *). (CanReject m', ICM m') =&gt; m' ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-428"></span><span>    </span><span id="local-6989586621679335388"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m' CanisterId
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-429"></span><span>    </span><span id="local-6989586621679335386"><span class="annot"><span class="annottext">Maybe
  (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="#local-6989586621679335386"><span class="hs-identifier hs-var">maybeSubnet</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId
-&gt; m'
     (Maybe
        (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)]))
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
CanisterId
-&gt; m (Maybe
        (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)]))
</span><a href="IC.Ref.Types.html#getSubnetFromSubnetId"><span class="hs-identifier hs-var">getSubnetFromSubnetId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-430"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="IC.Ref.Types.html#managementCanisterId"><span class="hs-identifier hs-var">managementCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%7C%7C"><span class="hs-operator hs-var">||</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
-&gt; Bool
forall a. Maybe a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Maybe.html#isJust"><span class="hs-identifier hs-var">isJust</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="#local-6989586621679335386"><span class="hs-identifier hs-var">maybeSubnet</span></a></span><span> </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-431"></span><span>      </span><span id="local-6989586621679335382"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335382"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m' CanisterId
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#callerOfCallID"><span class="hs-identifier hs-var">callerOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-432"></span><span>      </span><span class="annot"><span class="annottext">CanisterId
-&gt; Maybe
     (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
-&gt; CallId
-&gt; EntryPoint
-&gt; m' ()
forall (m :: * -&gt; *).
(CanReject m, ICM m, MonadIO m) =&gt;
CanisterId
-&gt; Maybe
     (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
-&gt; CallId
-&gt; EntryPoint
-&gt; m ()
</span><a href="IC.Ref.Management.html#invokeManagementCanister"><span class="hs-identifier hs-var">invokeManagementCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335382"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe
  (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="#local-6989586621679335386"><span class="hs-identifier hs-var">maybeSubnet</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679335471"><span class="hs-identifier hs-var">entry</span></a></span><span>
</span><span id="line-433"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-434"></span><span>      </span><span class="annot"><span class="annottext">CanisterId -&gt; m' ()
forall (m :: * -&gt; *). (CanReject m, ICM m) =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.Types.html#canisterMustExist"><span class="hs-identifier hs-var">canisterMustExist</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-435"></span><span>      </span><span id="local-6989586621679335379"><span class="annot"><span class="annottext">RunStatus
</span><a href="#local-6989586621679335379"><span class="hs-identifier hs-var">status</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' RunStatus
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m RunStatus
</span><a href="IC.Ref.Types.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-436"></span><span>      </span><span class="hs-keyword">case</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RunStatus
</span><a href="#local-6989586621679335379"><span class="hs-identifier hs-var">status</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679335471"><span class="hs-identifier hs-var">entry</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-437"></span><span>          </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m' ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-438"></span><span>          </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><span class="hs-identifier">_</span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Closure"><span class="hs-identifier hs-type">Closure</span></a></span><span class="hs-special">{</span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m' ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-439"></span><span>          </span><span class="hs-comment">-- This is a hack, detecting callbacks via the entry, and demands refactoring</span><span>
</span><span id="line-440"></span><span>          </span><span class="annot"><span class="annottext">(RunStatus, EntryPoint)
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_CANISTER_ERROR"><span class="hs-identifier hs-var">RC_CANISTER_ERROR</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;canister is not running&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_NOT_RUNNING"><span class="hs-identifier hs-var">EC_CANISTER_NOT_RUNNING</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-441"></span><span>      </span><span id="local-6989586621679335375"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679335375"><span class="hs-identifier hs-var">empty</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-442"></span><span>      </span><span class="annot"><span class="annottext">Bool -&gt; m' () -&gt; m' ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679335375"><span class="hs-identifier hs-var">empty</span></a></span><span> </span><span class="annot"><span class="annottext">(m' () -&gt; m' ()) -&gt; m' () -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m' ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;canister is empty&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_EMPTY"><span class="hs-identifier hs-var">EC_CANISTER_EMPTY</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-comment">-- NB: An empty canister cannot receive a callback.</span><span>
</span><span id="line-443"></span><span>      </span><span id="local-6989586621679335374"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335374"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' WasmState
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m WasmState
</span><a href="IC.Ref.Types.html#getCanisterState"><span class="hs-identifier hs-var">getCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-444"></span><span>      </span><span id="local-6989586621679335373"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335373"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' CanisterModule
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanisterModule
</span><a href="IC.Ref.Types.html#getCanisterMod"><span class="hs-identifier hs-var">getCanisterMod</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-445"></span><span>      </span><span id="local-6989586621679335372"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335372"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m' Env
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Env
</span><a href="IC.Ref.Types.html#canisterEnv"><span class="hs-identifier hs-var">canisterEnv</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span>
</span><span id="line-446"></span><span>      </span><span class="annot"><span class="annottext">CallId
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m' (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *).
ICM m =&gt;
CallId
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m (TrapOr (WasmState, UpdateResult))
</span><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-var">invokeEntry</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335374"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335373"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335372"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679335471"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="annot"><span class="annottext">m' (TrapOr (WasmState, UpdateResult))
-&gt; (TrapOr (WasmState, UpdateResult) -&gt; m' ()) -&gt; m' ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-447"></span><span>        </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679335370"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335370"><span class="hs-identifier hs-var">msg</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-448"></span><span>          </span><span class="hs-comment">-- Eventually update cycle balance here</span><span>
</span><span id="line-449"></span><span>          </span><span class="annot"><span class="annottext">CallId -&gt; MethodName -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; MethodName -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var">rememberTrap</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335370"><span class="hs-identifier hs-var">msg</span></a></span><span>
</span><span id="line-450"></span><span>        </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335369"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335369"><span class="hs-identifier hs-var">new_state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335368"><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335368"><span class="hs-identifier hs-var">call_actions</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335367"><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679335367"><span class="hs-identifier hs-var">canister_actions</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-451"></span><span>          </span><span class="annot"><span class="annottext">CanisterId -&gt; (CanState -&gt; CanState) -&gt; m' ()
forall (m :: * -&gt; *).
ICM m =&gt;
CanisterId -&gt; (CanState -&gt; CanState) -&gt; m ()
</span><a href="IC.Ref.Types.html#modCanister"><span class="hs-identifier hs-var">modCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">((CanState -&gt; CanState) -&gt; m' ())
-&gt; (CanState -&gt; CanState) -&gt; m' ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335365"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335365"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335365"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">last_action :: Maybe EntryPoint
</span><a href="IC.Ref.Types.html#last_action"><span class="hs-identifier hs-var">last_action</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryPoint -&gt; Maybe EntryPoint
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679335471"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-452"></span><span>          </span><span class="annot"><span class="annottext">CallId -&gt; CallActions -&gt; m' ()
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
CallId -&gt; CallActions -&gt; m ()
</span><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-var">performCallActions</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335472"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335368"><span class="hs-identifier hs-var">call_actions</span></a></span><span>
</span><span id="line-453"></span><span>          </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterActions -&gt; m' ()
forall (m :: * -&gt; *).
ICM m =&gt;
CanisterId -&gt; CanisterActions -&gt; m ()
</span><a href="IC.Ref.Types.html#performCanisterActions"><span class="hs-identifier hs-var">performCanisterActions</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679335367"><span class="hs-identifier hs-var">canister_actions</span></a></span><span>
</span><span id="line-454"></span><span>          </span><span class="annot"><span class="annottext">CanisterId -&gt; WasmState -&gt; m' ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; WasmState -&gt; m ()
</span><a href="IC.Ref.Types.html#setCanisterState"><span class="hs-identifier hs-var">setCanisterState</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335388"><span class="hs-identifier hs-var">callee</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335369"><span class="hs-identifier hs-var">new_state</span></a></span><span>
</span><span id="line-455"></span><span>
</span><span id="line-456"></span><span>  </span><span class="annot"><a href="IC.Ref.Types.html#ResponseMessage"><span class="hs-identifier hs-type">ResponseMessage</span></a></span><span> </span><span id="local-6989586621679335359"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335359"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335358"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679335358"><span class="hs-identifier hs-var">response</span></a></span></span><span> </span><span id="local-6989586621679335357"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335357"><span class="hs-identifier hs-var">refunded_cycles</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-457"></span><span>    </span><span id="local-6989586621679335356"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335356"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CallContext
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CallContext
</span><a href="IC.Ref.Types.html#getCallContext"><span class="hs-identifier hs-var">getCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335359"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-458"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var hs-var">origin</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335356"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-459"></span><span>      </span><span class="annot"><span class="annottext">CallOrigin
</span><a href="IC.Ref.Types.html#FromSystemTask"><span class="hs-identifier hs-var">FromSystemTask</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; m ()
forall a. HasCallStack =&gt; MethodName -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;Response from system task&quot;</span></span><span>
</span><span id="line-460"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#FromUser"><span class="hs-identifier hs-type">FromUser</span></a></span><span> </span><span id="local-6989586621679335353"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335353"><span class="hs-identifier hs-var">rid</span></a></span></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; RequestStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Blob -&gt; RequestStatus -&gt; m ()
</span><a href="IC.Ref.html#setReqStatus"><span class="hs-identifier hs-var">setReqStatus</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335353"><span class="hs-identifier hs-var">rid</span></a></span><span> </span><span class="annot"><span class="annottext">(RequestStatus -&gt; m ()) -&gt; RequestStatus -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallResponse -&gt; RequestStatus
</span><a href="IC.Ref.Types.html#CallResponse"><span class="hs-identifier hs-var">CallResponse</span></a></span><span> </span><span class="annot"><span class="annottext">(CallResponse -&gt; RequestStatus) -&gt; CallResponse -&gt; RequestStatus
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-461"></span><span>        </span><span class="hs-comment">-- NB: Here cycles disappear</span><span>
</span><span id="line-462"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679335358"><span class="hs-identifier hs-var">response</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-463"></span><span>          </span><span class="annot"><a href="IC.Types.html#Reject"><span class="hs-identifier hs-type">Reject</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335352"><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679335352"><span class="hs-identifier hs-var">rc</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335351"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335351"><span class="hs-identifier hs-var">msg</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(RejectCode, MethodName, Maybe ErrorCode) -&gt; CallResponse
</span><a href="IC.Ref.Types.html#canisterRejected"><span class="hs-identifier hs-var">canisterRejected</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="#local-6989586621679335352"><span class="hs-identifier hs-var">rc</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335351"><span class="hs-identifier hs-var">msg</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Maybe ErrorCode
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-464"></span><span>          </span><span class="annot"><a href="IC.Types.html#Reply"><span class="hs-identifier hs-type">Reply</span></a></span><span> </span><span id="local-6989586621679335350"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335350"><span class="hs-identifier hs-var">blob</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Blob -&gt; CallResponse
</span><a href="IC.Ref.Types.html#Replied"><span class="hs-identifier hs-var">Replied</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335350"><span class="hs-identifier hs-var">blob</span></a></span><span>
</span><span id="line-465"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679335348"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335348"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335347"><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679335347"><span class="hs-identifier hs-var">callback</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-466"></span><span>        </span><span class="hs-comment">-- Add refund to balance</span><span>
</span><span id="line-467"></span><span>        </span><span id="local-6989586621679335346"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335346"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CanisterId
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335348"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-468"></span><span>        </span><span id="local-6989586621679335345"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335345"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335346"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-469"></span><span>        </span><span class="annot"><span class="annottext">CanisterId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335346"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335345"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335357"><span class="hs-identifier hs-var">refunded_cycles</span></a></span><span>
</span><span id="line-470"></span><span>        </span><span class="hs-comment">-- Unless deleted</span><span>
</span><span id="line-471"></span><span>        </span><span id="local-6989586621679335341"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679335341"><span class="hs-identifier hs-var">d</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Bool
</span><a href="IC.Ref.html#deletedCallID"><span class="hs-identifier hs-var">deletedCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335348"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-472"></span><span>        </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679335341"><span class="hs-identifier hs-var">d</span></a></span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-473"></span><span>          </span><span class="hs-comment">-- Enqueue execution</span><span>
</span><span id="line-474"></span><span>          </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.Types.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m ()) -&gt; Message -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallMessage :: CallId -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-475"></span><span>            </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335348"><span class="hs-identifier hs-var">other_ctxt_id</span></a></span><span>
</span><span id="line-476"></span><span>            </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Callback -&gt; Response -&gt; Natural -&gt; EntryPoint
</span><a href="IC.Ref.Types.html#Closure"><span class="hs-identifier hs-var">Closure</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679335347"><span class="hs-identifier hs-var">callback</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679335358"><span class="hs-identifier hs-var">response</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335357"><span class="hs-identifier hs-var">refunded_cycles</span></a></span><span>
</span><span id="line-477"></span><span>            </span><span class="hs-special">}</span><span>
</span><span id="line-478"></span><span>
</span><span id="line-479"></span><span id="local-6989586621679336668"><span class="annot"><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-type">performCallActions</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336668"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336668"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CallActions"><span class="hs-identifier hs-type">CallActions</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336668"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-480"></span><span id="performCallActions"><span class="annot"><span class="annottext">performCallActions :: forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
CallId -&gt; CallActions -&gt; m ()
</span><a href="IC.Ref.html#performCallActions"><span class="hs-identifier hs-var hs-var">performCallActions</span></a></span></span><span> </span><span id="local-6989586621679335316"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335316"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335315"><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335315"><span class="hs-identifier hs-var">ca</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-481"></span><span>  </span><span class="annot"><span class="annottext">CallId -&gt; [MethodCall] -&gt; Natural -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; [MethodCall] -&gt; Natural -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-var">updateBalances</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335316"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var hs-var">ca_new_calls</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335315"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Natural
</span><a href="IC.Types.html#ca_accept"><span class="hs-identifier hs-var hs-var">ca_accept</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335315"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Natural
</span><a href="IC.Types.html#ca_mint"><span class="hs-identifier hs-var hs-var">ca_mint</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335315"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-482"></span><span>  </span><span class="annot"><span class="annottext">(MethodCall -&gt; m ()) -&gt; [MethodCall] -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallId -&gt; MethodCall -&gt; m ()
forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
CallId -&gt; MethodCall -&gt; m ()
</span><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-var">newCall</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335316"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var hs-var">ca_new_calls</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335315"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-483"></span><span>  </span><span class="annot"><span class="annottext">(Response -&gt; m ()) -&gt; Maybe Response -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#mapM_"><span class="hs-identifier hs-var">mapM_</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallId -&gt; Response -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; Response -&gt; m ()
</span><a href="IC.Ref.Types.html#respondCallContext"><span class="hs-identifier hs-var">respondCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335316"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions -&gt; Maybe Response
</span><a href="IC.Types.html#ca_response"><span class="hs-identifier hs-var hs-var">ca_response</span></a></span><span> </span><span class="annot"><span class="annottext">CallActions
</span><a href="#local-6989586621679335315"><span class="hs-identifier hs-var">ca</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-484"></span><span>
</span><span id="line-485"></span><span>
</span><span id="line-486"></span><span id="local-6989586621679336657"><span class="annot"><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-type">updateBalances</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">[</span><span class="annot"><a href="IC.Types.html#MethodCall"><span class="hs-identifier hs-type">MethodCall</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Cycles"><span class="hs-identifier hs-type">Cycles</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336657"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-487"></span><span id="updateBalances"><span class="annot"><span class="annottext">updateBalances :: forall (m :: * -&gt; *).
ICM m =&gt;
CallId -&gt; [MethodCall] -&gt; Natural -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.html#updateBalances"><span class="hs-identifier hs-var hs-var">updateBalances</span></a></span></span><span> </span><span id="local-6989586621679335263"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335263"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335262"><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679335262"><span class="hs-identifier hs-var">new_calls</span></a></span></span><span> </span><span id="local-6989586621679335261"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335261"><span class="hs-identifier hs-var">accepted</span></a></span></span><span> </span><span id="local-6989586621679335260"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335260"><span class="hs-identifier hs-var">minted</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-488"></span><span>  </span><span id="local-6989586621679335259"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335259"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CanisterId
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335263"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-489"></span><span>
</span><span id="line-490"></span><span>  </span><span class="hs-comment">-- Eventually update when we track cycle consumption</span><span>
</span><span id="line-491"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335257"><span class="annot"><span class="annottext">max_cycles :: Natural
</span><a href="#local-6989586621679335257"><span class="hs-identifier hs-var hs-var">max_cycles</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-492"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335255"><span class="annot"><span class="annottext">cycles_consumed :: Natural
</span><a href="#local-6989586621679335255"><span class="hs-identifier hs-var hs-var">cycles_consumed</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-493"></span><span>
</span><span id="line-494"></span><span>  </span><span id="local-6989586621679335254"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335254"><span class="hs-identifier hs-var">prev_balance</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getBalance"><span class="hs-identifier hs-var">getBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335259"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-495"></span><span>  </span><span id="local-6989586621679335253"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335253"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335263"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-496"></span><span>  </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335261"><span class="hs-identifier hs-var">accepted</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335253"><span class="hs-identifier hs-var">available</span></a></span><span>
</span><span id="line-497"></span><span>  </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-498"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335251"><span class="annot"><span class="annottext">to_spend :: Natural
</span><a href="#local-6989586621679335251"><span class="hs-identifier hs-var hs-var">to_spend</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335254"><span class="hs-identifier hs-var">prev_balance</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335261"><span class="hs-identifier hs-var">accepted</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335260"><span class="hs-identifier hs-var">minted</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335257"><span class="hs-identifier hs-var">max_cycles</span></a></span><span>
</span><span id="line-499"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335250"><span class="annot"><span class="annottext">transferred :: Natural
</span><a href="#local-6989586621679335250"><span class="hs-identifier hs-var hs-var">transferred</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Natural] -&gt; Natural
forall (t :: * -&gt; *) a. (Foldable t, Num a) =&gt; t a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#sum"><span class="hs-identifier hs-var">sum</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; Natural
</span><a href="IC.Types.html#call_transferred_cycles"><span class="hs-identifier hs-var hs-var">call_transferred_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335247"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679335247"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335247"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679335262"><span class="hs-identifier hs-var">new_calls</span></a></span><span class="hs-special">]</span><span>
</span><span id="line-500"></span><span>    </span><span class="hs-keyword">if</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335250"><span class="hs-identifier hs-var">transferred</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3C%3D"><span class="hs-operator hs-var">&lt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335251"><span class="hs-identifier hs-var">to_spend</span></a></span><span>
</span><span id="line-501"></span><span>    </span><span class="hs-keyword">then</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-502"></span><span>      </span><span class="annot"><span class="annottext">CanisterId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setBalance"><span class="hs-identifier hs-var">setBalance</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335259"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335254"><span class="hs-identifier hs-var">prev_balance</span></a></span><span>
</span><span id="line-503"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335261"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-504"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335260"><span class="hs-identifier hs-var">minted</span></a></span><span>
</span><span id="line-505"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335255"><span class="hs-identifier hs-var">cycles_consumed</span></a></span><span>
</span><span id="line-506"></span><span>        </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335250"><span class="hs-identifier hs-var">transferred</span></a></span><span>
</span><span id="line-507"></span><span>      </span><span class="annot"><span class="annottext">CallId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setCallContextCycles"><span class="hs-identifier hs-var">setCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335263"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">(Natural -&gt; m ()) -&gt; Natural -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335253"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Natural
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#-"><span class="hs-glyph hs-var">-</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335261"><span class="hs-identifier hs-var">accepted</span></a></span><span>
</span><span id="line-508"></span><span>    </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; m ()
forall a. HasCallStack =&gt; MethodName -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;Internal error: More cycles transferred than available&quot;</span></span><span>
</span><span id="line-509"></span><span>  </span><span class="hs-keyword">else</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; m ()
forall a. HasCallStack =&gt; MethodName -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;Internal error: More cycles accepted than available&quot;</span></span><span>
</span><span id="line-510"></span><span>
</span><span id="line-511"></span><span>
</span><span id="line-512"></span><span id="local-6989586621679336646"><span class="annot"><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-type">actuallyStopCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336646"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336646"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-513"></span><span id="actuallyStopCanister"><span class="annot"><span class="annottext">actuallyStopCanister :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-var hs-var">actuallyStopCanister</span></a></span></span><span> </span><span id="local-6989586621679335210"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335210"><span class="hs-identifier hs-var">canister_id</span></a></span></span><span> </span><span class="hs-glyph">=</span><span>
</span><span id="line-514"></span><span>    </span><span class="annot"><span class="annottext">CanisterId -&gt; m RunStatus
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m RunStatus
</span><a href="IC.Ref.Types.html#getRunStatus"><span class="hs-identifier hs-var">getRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335210"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">m RunStatus -&gt; (RunStatus -&gt; m ()) -&gt; m ()
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span>
</span><span id="line-515"></span><span>        </span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679335209"><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679335209"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-516"></span><span>            </span><span class="annot"><span class="annottext">CanisterId -&gt; RunStatus -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; RunStatus -&gt; m ()
</span><a href="IC.Ref.Types.html#setRunStatus"><span class="hs-identifier hs-var">setRunStatus</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335210"><span class="hs-identifier hs-var">canister_id</span></a></span><span> </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsStopped"><span class="hs-identifier hs-var">IsStopped</span></a></span><span>
</span><span id="line-517"></span><span>            </span><span class="annot"><span class="annottext">[CallId] -&gt; (CallId -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679335209"><span class="hs-identifier hs-var">pending</span></a></span><span> </span><span class="annot"><span class="annottext">((CallId -&gt; m ()) -&gt; m ()) -&gt; (CallId -&gt; m ()) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335206"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335206"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-518"></span><span>              </span><span class="annot"><span class="annottext">CallId -&gt; Blob -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; Blob -&gt; m ()
</span><a href="IC.Ref.Types.html#replyCallContext"><span class="hs-identifier hs-var">replyCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335206"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">() -&gt; Blob
forall a. CandidArg a =&gt; a -&gt; Blob
</span><a href="file:///nix/store/5q8knwbpcq1xjhfifih1jfwmvd2jr0sg-candid-0.4-doc/share/doc/candid-0.4/html/src/Codec.Candid.Class.html#encode"><span class="hs-identifier hs-var">Codec.Candid.encode</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-519"></span><span>        </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsRunning"><span class="hs-identifier hs-var">IsRunning</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; m ()
forall a. HasCallStack =&gt; MethodName -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;unexpected canister status&quot;</span></span><span>
</span><span id="line-520"></span><span>        </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsStopped"><span class="hs-identifier hs-var">IsStopped</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; m ()
forall a. HasCallStack =&gt; MethodName -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;unexpected canister status&quot;</span></span><span>
</span><span id="line-521"></span><span>        </span><span class="annot"><span class="annottext">RunStatus
</span><a href="IC.Ref.Types.html#IsDeleted"><span class="hs-identifier hs-var">IsDeleted</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; m ()
forall a. HasCallStack =&gt; MethodName -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Err.html#error"><span class="hs-identifier hs-var">error</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;deleted canister encountered&quot;</span></span><span>
</span><span id="line-522"></span><span>
</span><span id="line-523"></span><span> </span><span>
</span><span id="line-524"></span><span id="local-6989586621679336672"><span class="annot"><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-type">invokeEntry</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336672"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span>
</span><span id="line-525"></span><span>    </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Canister.html#CanisterModule"><span class="hs-identifier hs-type">CanisterModule</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Env"><span class="hs-identifier hs-type">Env</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#EntryPoint"><span class="hs-identifier hs-type">EntryPoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-526"></span><span>    </span><span class="annot"><a href="#local-6989586621679336672"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#TrapOr"><span class="hs-identifier hs-type">TrapOr</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Canister.html#WasmState"><span class="hs-identifier hs-type">WasmState</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#UpdateResult"><span class="hs-identifier hs-type">UpdateResult</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-527"></span><span id="invokeEntry"><span class="annot"><span class="annottext">invokeEntry :: forall (m :: * -&gt; *).
ICM m =&gt;
CallId
-&gt; WasmState
-&gt; CanisterModule
-&gt; Env
-&gt; EntryPoint
-&gt; m (TrapOr (WasmState, UpdateResult))
</span><a href="IC.Ref.html#invokeEntry"><span class="hs-identifier hs-var hs-var">invokeEntry</span></a></span></span><span> </span><span id="local-6989586621679335173"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335173"><span class="hs-identifier hs-var">ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335172"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span> </span><span id="local-6989586621679335171"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335171"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span> </span><span id="local-6989586621679335170"><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335170"><span class="hs-identifier hs-var">env</span></a></span></span><span> </span><span id="local-6989586621679335169"><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679335169"><span class="hs-identifier hs-var">entry</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-528"></span><span>    </span><span id="local-6989586621679335168"><span class="annot"><span class="annottext">NeedsToRespond
</span><a href="#local-6989586621679335168"><span class="hs-identifier hs-var">needs_to_respond</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m NeedsToRespond
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m NeedsToRespond
</span><a href="IC.Ref.html#needsToRespondCallID"><span class="hs-identifier hs-var">needsToRespondCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335173"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-529"></span><span>    </span><span id="local-6989586621679335167"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335167"><span class="hs-identifier hs-var">available</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getCallContextCycles"><span class="hs-identifier hs-var">getCallContextCycles</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335173"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-530"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="#local-6989586621679335169"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-531"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#Public"><span class="hs-identifier hs-type">Public</span></a></span><span> </span><span id="local-6989586621679335166"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335166"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679335165"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335165"><span class="hs-identifier hs-var">dat</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-532"></span><span>        </span><span id="local-6989586621679335164"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335164"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CanisterId
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#callerOfCallID"><span class="hs-identifier hs-var">callerOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335173"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span>
</span><span id="line-533"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">MethodName
-&gt; CanisterModule
-&gt; Maybe
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="#local-6989586621679335163"><span class="hs-identifier hs-var">lookupUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335166"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335171"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-534"></span><span>          </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679335162"><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679335162"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679335162"><span class="hs-identifier hs-var">f</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335164"><span class="hs-identifier hs-var">caller</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335170"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsToRespond
</span><a href="#local-6989586621679335168"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335167"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335165"><span class="hs-identifier hs-var">dat</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span>
</span><span id="line-535"></span><span>          </span><span class="annot"><span class="annottext">Maybe
  (CanisterId
   -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-536"></span><span>            </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335161"><span class="annot"><span class="annottext">reject :: Response
</span><a href="#local-6989586621679335161"><span class="hs-identifier hs-var hs-var">reject</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(RejectCode, MethodName) -&gt; Response
</span><a href="IC.Types.html#Reject"><span class="hs-identifier hs-var">Reject</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;method does not exist: &quot;</span></span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; MethodName -&gt; MethodName
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335166"><span class="hs-identifier hs-var">method</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-537"></span><span>            </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ca_response :: Maybe Response
</span><a href="IC.Types.html#ca_response"><span class="hs-identifier hs-var">ca_response</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Response -&gt; Maybe Response
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679335161"><span class="hs-identifier hs-var">reject</span></a></span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-538"></span><span>      </span><span class="annot"><a href="IC.Ref.Types.html#Closure"><span class="hs-identifier hs-type">Closure</span></a></span><span> </span><span id="local-6989586621679335158"><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679335158"><span class="hs-identifier hs-var">cb</span></a></span></span><span> </span><span id="local-6989586621679335157"><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679335157"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span id="local-6989586621679335156"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335156"><span class="hs-identifier hs-var">refund</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-539"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; Callback
-&gt; Env
-&gt; NeedsToRespond
-&gt; Natural
-&gt; Response
-&gt; Natural
-&gt; UpdateFunc
</span><a href="IC.Canister.html#callbacks"><span class="hs-identifier hs-var hs-var">callbacks</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335171"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679335158"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335170"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">NeedsToRespond
</span><a href="#local-6989586621679335168"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335167"><span class="hs-identifier hs-var">available</span></a></span><span> </span><span class="annot"><span class="annottext">Response
</span><a href="#local-6989586621679335157"><span class="hs-identifier hs-var">r</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679335156"><span class="hs-identifier hs-var">refund</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-540"></span><span>            </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679335154"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335154"><span class="hs-identifier hs-var">err</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-541"></span><span>              </span><span class="annot"><span class="annottext">CallId -&gt; MethodName -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; MethodName -&gt; m ()
</span><a href="IC.Ref.html#rememberTrap"><span class="hs-identifier hs-var">rememberTrap</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335173"><span class="hs-identifier hs-var">ctxt_id</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335154"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-542"></span><span>              </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-543"></span><span>                  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Callback -&gt; Maybe WasmClosure
</span><a href="IC.Types.html#cleanup_callback"><span class="hs-identifier hs-var hs-var">cleanup_callback</span></a></span><span> </span><span class="annot"><span class="annottext">Callback
</span><a href="#local-6989586621679335158"><span class="hs-identifier hs-var">cb</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-544"></span><span>                      </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679335152"><span class="annot"><span class="annottext">WasmClosure
</span><a href="#local-6989586621679335152"><span class="hs-identifier hs-var">closure</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; WasmClosure -&gt; Env -&gt; WasmState -&gt; TrapOr (WasmState, ())
</span><a href="IC.Canister.html#cleanup"><span class="hs-identifier hs-var hs-var">cleanup</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335171"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">WasmClosure
</span><a href="#local-6989586621679335152"><span class="hs-identifier hs-var">closure</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335170"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-545"></span><span>                          </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span id="local-6989586621679335150"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335150"><span class="hs-identifier hs-var">err'</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; TrapOr (WasmState, UpdateResult)
forall a. MethodName -&gt; TrapOr a
</span><a href="IC.Types.html#Trap"><span class="hs-identifier hs-var">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335150"><span class="hs-identifier hs-var">err'</span></a></span><span>
</span><span id="line-546"></span><span>                          </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335149"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335149"><span class="hs-identifier hs-var">wasm_state'</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-547"></span><span>                              </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335149"><span class="hs-identifier hs-var">wasm_state'</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-548"></span><span>                      </span><span class="annot"><span class="annottext">Maybe WasmClosure
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; TrapOr (WasmState, UpdateResult)
forall a. MethodName -&gt; TrapOr a
</span><a href="IC.Types.html#Trap"><span class="hs-identifier hs-var">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335154"><span class="hs-identifier hs-var">err</span></a></span><span>
</span><span id="line-549"></span><span>            </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335148"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335148"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335147"><span class="annot"><span class="annottext">UpdateResult
</span><a href="#local-6989586621679335147"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335148"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">UpdateResult
</span><a href="#local-6989586621679335147"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-550"></span><span>      </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#Heartbeat"><span class="hs-identifier hs-var">Heartbeat</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-551"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; Env
-&gt; WasmState
-&gt; TrapOr (WasmState, ([MethodCall], CanisterActions))
</span><a href="IC.Canister.html#heartbeat"><span class="hs-identifier hs-var hs-var">heartbeat</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335171"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335170"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-552"></span><span>            </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-553"></span><span>            </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335144"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335144"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335143"><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679335143"><span class="hs-identifier hs-var">calls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335142"><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679335142"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-554"></span><span>                </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335144"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ca_new_calls :: [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var">ca_new_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679335143"><span class="hs-identifier hs-var">calls</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679335142"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-555"></span><span>      </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#GlobalTimer"><span class="hs-identifier hs-var">GlobalTimer</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">(TrapOr (WasmState, UpdateResult)
 -&gt; m (TrapOr (WasmState, UpdateResult)))
-&gt; TrapOr (WasmState, UpdateResult)
-&gt; m (TrapOr (WasmState, UpdateResult))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-556"></span><span>        </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">CanisterModule
-&gt; Env
-&gt; WasmState
-&gt; TrapOr (WasmState, ([MethodCall], CanisterActions))
</span><a href="IC.Canister.html#canister_global_timer"><span class="hs-identifier hs-var hs-var">canister_global_timer</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335171"><span class="hs-identifier hs-var">can_mod</span></a></span><span> </span><span class="annot"><span class="annottext">Env
</span><a href="#local-6989586621679335170"><span class="hs-identifier hs-var">env</span></a></span><span> </span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-557"></span><span>            </span><span class="annot"><a href="IC.Types.html#Trap"><span class="hs-identifier hs-type">Trap</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335172"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="IC.Types.html#noCanisterActions"><span class="hs-identifier hs-var">noCanisterActions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-558"></span><span>            </span><span class="annot"><a href="IC.Types.html#Return"><span class="hs-identifier hs-type">Return</span></a></span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335139"><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335139"><span class="hs-identifier hs-var">wasm_state</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335138"><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679335138"><span class="hs-identifier hs-var">calls</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335137"><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679335137"><span class="hs-identifier hs-var">actions</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-559"></span><span>                </span><span class="annot"><span class="annottext">(WasmState, UpdateResult) -&gt; TrapOr (WasmState, UpdateResult)
forall a. a -&gt; TrapOr a
</span><a href="IC.Types.html#Return"><span class="hs-identifier hs-var">Return</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">WasmState
</span><a href="#local-6989586621679335139"><span class="hs-identifier hs-var">wasm_state</span></a></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallActions
</span><a href="IC.Types.html#noCallActions"><span class="hs-identifier hs-var">noCallActions</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">ca_new_calls :: [MethodCall]
</span><a href="IC.Types.html#ca_new_calls"><span class="hs-identifier hs-var">ca_new_calls</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[MethodCall]
</span><a href="#local-6989586621679335138"><span class="hs-identifier hs-var">calls</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CanisterActions
</span><a href="#local-6989586621679335137"><span class="hs-identifier hs-var">actions</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span>
</span><span id="line-560"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-561"></span><span>    </span><span id="local-6989586621679335163"><span class="annot"><span class="annottext">lookupUpdate :: MethodName
-&gt; CanisterModule
-&gt; Maybe
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="#local-6989586621679335163"><span class="hs-identifier hs-var hs-var">lookupUpdate</span></a></span></span><span> </span><span id="local-6989586621679335133"><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335133"><span class="hs-identifier hs-var">method</span></a></span></span><span> </span><span id="local-6989586621679335132"><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335132"><span class="hs-identifier hs-var">can_mod</span></a></span></span><span>
</span><span id="line-562"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679335131"><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679335131"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MethodName
-&gt; Map
     MethodName
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
-&gt; Maybe
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335133"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule
-&gt; Map
     MethodName
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
</span><a href="IC.Canister.html#update_methods"><span class="hs-identifier hs-var hs-var">update_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335132"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanisterId
 -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
-&gt; Maybe
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
-&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc
</span><a href="#local-6989586621679335131"><span class="hs-identifier hs-var">f</span></a></span><span>
</span><span id="line-563"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span id="local-6989586621679335129"><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679335129"><span class="hs-identifier hs-var">f</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">MethodName
-&gt; Map MethodName (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; Maybe (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
forall k a. Ord k =&gt; k -&gt; Map k a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#lookup"><span class="hs-identifier hs-var">M.lookup</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><a href="#local-6989586621679335133"><span class="hs-identifier hs-var">method</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CanisterModule
-&gt; Map MethodName (CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
</span><a href="IC.Canister.html#query_methods"><span class="hs-identifier hs-var hs-var">query_methods</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterModule
</span><a href="#local-6989586621679335132"><span class="hs-identifier hs-var">can_mod</span></a></span><span class="hs-special">)</span><span>  </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanisterId
 -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
-&gt; Maybe
     (CanisterId
      -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc)
-&gt; CanisterId
-&gt; Env
-&gt; NeedsToRespond
-&gt; Natural
-&gt; Blob
-&gt; UpdateFunc
</span><a href="IC.Canister.html#asUpdate"><span class="hs-identifier hs-var">asUpdate</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; Env -&gt; Blob -&gt; QueryFunc
</span><a href="#local-6989586621679335129"><span class="hs-identifier hs-var">f</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-564"></span><span>        </span><span class="hs-glyph">|</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#otherwise"><span class="hs-identifier hs-var">otherwise</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe
  (CanisterId
   -&gt; Env -&gt; NeedsToRespond -&gt; Natural -&gt; Blob -&gt; UpdateFunc)
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-565"></span><span>
</span><span id="line-566"></span><span id="local-6989586621679336652"><span class="annot"><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-type">newCall</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336652"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanReject"><span class="hs-identifier hs-type">CanReject</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336652"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#MethodCall"><span class="hs-identifier hs-type">MethodCall</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336652"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-567"></span><span id="newCall"><span class="annot"><span class="annottext">newCall :: forall (m :: * -&gt; *).
(ICM m, CanReject m) =&gt;
CallId -&gt; MethodCall -&gt; m ()
</span><a href="IC.Ref.html#newCall"><span class="hs-identifier hs-var hs-var">newCall</span></a></span></span><span> </span><span id="local-6989586621679335094"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335094"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span></span><span> </span><span id="local-6989586621679335093"><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335093"><span class="hs-identifier hs-var">call</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-568"></span><span>  </span><span id="local-6989586621679335092"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335092"><span class="hs-identifier hs-var">caller</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m CanisterId
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m CanisterId
</span><a href="IC.Ref.Types.html#calleeOfCallID"><span class="hs-identifier hs-var">calleeOfCallID</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335094"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span><span>
</span><span id="line-569"></span><span>  </span><span id="local-6989586621679335091"><span class="annot"><span class="annottext">(CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="#local-6989586621679335091"><span class="hs-identifier hs-var">caller_subnet_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId
-&gt; m (CanisterId, SubnetType, Word64, SecretKey,
      [(Word64, Word64)])
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
CanisterId
-&gt; m (CanisterId, SubnetType, Word64, SecretKey,
      [(Word64, Word64)])
</span><a href="IC.Ref.Types.html#getSubnetFromCanisterId"><span class="hs-identifier hs-var">getSubnetFromCanisterId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335092"><span class="hs-identifier hs-var">caller</span></a></span><span>
</span><span id="line-570"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679335090"><span class="annot"><span class="annottext">target :: CanisterId
</span><a href="#local-6989586621679335090"><span class="hs-identifier hs-var hs-var">target</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; CanisterId
</span><a href="IC.Types.html#call_callee"><span class="hs-identifier hs-var hs-var">call_callee</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335093"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-571"></span><span>  </span><span id="local-6989586621679335088"><span class="annot"><span class="annottext">Maybe
  (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="#local-6989586621679335088"><span class="hs-identifier hs-var">target_subnet_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId
-&gt; m (Maybe
        (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)]))
forall (m :: * -&gt; *).
(CanReject m, ICM m) =&gt;
CanisterId
-&gt; m (Maybe
        (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)]))
</span><a href="IC.Ref.Types.html#getSubnetFromSubnetId"><span class="hs-identifier hs-var">getSubnetFromSubnetId</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335090"><span class="hs-identifier hs-var">target</span></a></span><span>
</span><span id="line-572"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Control.Monad.html#unless"><span class="hs-identifier hs-var">unless</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">(CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
-&gt; Bool
</span><a href="IC.Ref.Types.html#isRootSubnet"><span class="hs-identifier hs-var">isRootSubnet</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="#local-6989586621679335091"><span class="hs-identifier hs-var">caller_subnet_id</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-573"></span><span>    </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">Maybe
  (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="#local-6989586621679335088"><span class="hs-identifier hs-var">target_subnet_id</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-574"></span><span>      </span><span class="annot"><span class="annottext">Maybe
  (CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">() -&gt; m ()
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-575"></span><span>      </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">(CanisterId, SubnetType, Word64, SecretKey, [(Word64, Word64)])
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m ()
forall (m :: * -&gt; *) a2.
CanReject m =&gt;
RejectCode -&gt; MethodName -&gt; Maybe ErrorCode -&gt; m a2
</span><a href="IC.Ref.Types.html#reject"><span class="hs-identifier hs-var">reject</span></a></span><span> </span><span class="annot"><span class="annottext">RejectCode
</span><a href="IC.Types.html#RC_DESTINATION_INVALID"><span class="hs-identifier hs-var">RC_DESTINATION_INVALID</span></a></span><span> </span><span class="annot"><span class="annottext">MethodName
</span><span class="hs-string">&quot;Only NNS canisters can call a subnet ID directly.&quot;</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ErrorCode -&gt; Maybe ErrorCode
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">ErrorCode
</span><a href="IC.Types.html#EC_CANISTER_NOT_FOUND"><span class="hs-identifier hs-var">EC_CANISTER_NOT_FOUND</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-576"></span><span>  </span><span id="local-6989586621679335085"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335085"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; m CallId
forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; m CallId) -&gt; CallContext -&gt; m CallId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext :: CanisterId
-&gt; CallOrigin
-&gt; NeedsToRespond
-&gt; Bool
-&gt; Natural
-&gt; Maybe MethodName
-&gt; CallContext
</span><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-577"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335090"><span class="hs-identifier hs-var">target</span></a></span><span>
</span><span id="line-578"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId -&gt; Callback -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#FromCanister"><span class="hs-identifier hs-var">FromCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335094"><span class="hs-identifier hs-var">from_ctxt_id</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; Callback
</span><a href="IC.Types.html#call_callback"><span class="hs-identifier hs-var hs-var">call_callback</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335093"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-579"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-580"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-581"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe MethodName
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe MethodName
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-582"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodCall -&gt; Natural
</span><a href="IC.Types.html#call_transferred_cycles"><span class="hs-identifier hs-var hs-var">call_transferred_cycles</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335093"><span class="hs-identifier hs-var">call</span></a></span><span>
</span><span id="line-583"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-584"></span><span>  </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.Types.html#enqueueMessage"><span class="hs-identifier hs-var">enqueueMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m ()) -&gt; Message -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallMessage :: CallId -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-585"></span><span>    </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335085"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span>
</span><span id="line-586"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">MethodName -&gt; Blob -&gt; EntryPoint
</span><a href="IC.Ref.Types.html#Public"><span class="hs-identifier hs-var">Public</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; MethodName
</span><a href="IC.Types.html#call_method_name"><span class="hs-identifier hs-var hs-var">call_method_name</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335093"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">MethodCall -&gt; Blob
</span><a href="IC.Types.html#call_arg"><span class="hs-identifier hs-var hs-var">call_arg</span></a></span><span> </span><span class="annot"><span class="annottext">MethodCall
</span><a href="#local-6989586621679335093"><span class="hs-identifier hs-var">call</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-587"></span><span>    </span><span class="hs-special">}</span><span>
</span><span id="line-588"></span><span>
</span><span id="line-589"></span><span class="hs-comment">-- Scheduling</span><span>
</span><span id="line-590"></span><span>
</span><span id="line-591"></span><span class="hs-comment">-- | Pick next request in state `received`</span><span>
</span><span id="line-592"></span><span id="local-6989586621679336635"><span class="annot"><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-type">nextReceived</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336635"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336635"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="IC.Types.html#RequestID"><span class="hs-identifier hs-type">RequestID</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallRequest"><span class="hs-identifier hs-type">CallRequest</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span></span><span>
</span><span id="line-593"></span><span id="nextReceived"><span class="annot"><span class="annottext">nextReceived :: forall (m :: * -&gt; *).
ICM m =&gt;
m (Maybe (Blob, CallRequest, CanisterId))
</span><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-var hs-var">nextReceived</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe (Blob, CallRequest, CanisterId))
-&gt; m (Maybe (Blob, CallRequest, CanisterId))
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; Maybe (Blob, CallRequest, CanisterId))
 -&gt; m (Maybe (Blob, CallRequest, CanisterId)))
-&gt; (IC -&gt; Maybe (Blob, CallRequest, CanisterId))
-&gt; m (Maybe (Blob, CallRequest, CanisterId))
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335077"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335077"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[(Blob, CallRequest, CanisterId)]
-&gt; Maybe (Blob, CallRequest, CanisterId)
forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-594"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335075"><span class="hs-identifier hs-var">rid</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679335074"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">,</span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335073"><span class="hs-identifier hs-var">ecid</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335075"><span class="annot"><span class="annottext">Blob
</span><a href="#local-6989586621679335075"><span class="hs-identifier hs-var">rid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335074"><span class="annot"><span class="annottext">CallRequest
</span><a href="#local-6989586621679335074"><span class="hs-identifier hs-var">r</span></a></span></span><span class="hs-special">,</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">RequestStatus
</span><a href="IC.Ref.Types.html#Received"><span class="hs-identifier hs-var">Received</span></a></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335073"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335073"><span class="hs-identifier hs-var">ecid</span></a></span></span><span class="hs-special">)</span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map Blob (CallRequest, (RequestStatus, CanisterId))
-&gt; [(Blob, (CallRequest, (RequestStatus, CanisterId)))]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map Blob (CallRequest, (RequestStatus, CanisterId))
</span><a href="IC.Ref.Types.html#requests"><span class="hs-identifier hs-var hs-var">requests</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335077"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span>
</span><span id="line-595"></span><span>
</span><span id="line-596"></span><span class="hs-comment">-- A call context is still waiting for a response if&#8230;</span><span>
</span><span id="line-597"></span><span class="annot"><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-type">willReceiveResponse</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IC"><span class="hs-identifier hs-type">IC</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-598"></span><span id="willReceiveResponse"><span class="annot"><span class="annottext">willReceiveResponse :: IC -&gt; CallId -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var hs-var">willReceiveResponse</span></a></span></span><span> </span><span id="local-6989586621679335071"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335071"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span id="local-6989586621679335070"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335070"><span class="hs-identifier hs-var">c</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335070"><span class="hs-identifier hs-var">c</span></a></span><span> </span><span class="annot"><span class="annottext">CallId -&gt; [CallId] -&gt; Bool
forall (t :: * -&gt; *) a. (Foldable t, Eq a) =&gt; a -&gt; t a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#elem"><span class="hs-operator hs-var">`elem`</span></a></span><span>
</span><span id="line-599"></span><span>  </span><span class="hs-comment">-- there is another call context promising to respond to this</span><span>
</span><span id="line-600"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335069"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-601"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: CallContext -&gt; NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-type">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: CallContext -&gt; Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallContext -&gt; CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#FromCanister"><span class="hs-identifier hs-type">FromCanister</span></a></span><span> </span><span id="local-6989586621679335069"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335069"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="annot"><span class="annottext">Callback
</span><span class="hs-identifier">_</span></span><span class="hs-special">}</span><span>
</span><span id="line-602"></span><span>      </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map CallId CallContext -&gt; [CallContext]
forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">M.elems</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CallId CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335071"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-603"></span><span>  </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CallId] -&gt; [CallId] -&gt; [CallId]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-604"></span><span>  </span><span class="hs-comment">-- there is an in-flight call or response message:</span><span>
</span><span id="line-605"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">Message -&gt; CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var hs-var">call_context</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679335067"><span class="hs-identifier hs-var">m</span></a></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="local-6989586621679335067"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679335067"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Seq Message -&gt; [Message]
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#toList"><span class="hs-identifier hs-var">toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.Types.html#messages"><span class="hs-identifier hs-var hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335071"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">]</span><span> </span><span class="annot"><span class="annottext">[CallId] -&gt; [CallId] -&gt; [CallId]
forall a. [a] -&gt; [a] -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%2B%2B"><span class="hs-operator hs-var">++</span></a></span><span>
</span><span id="line-606"></span><span>  </span><span class="hs-comment">-- there this canister is waiting for some canister to stop</span><span>
</span><span id="line-607"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335065"><span class="hs-identifier hs-var">c'</span></a></span><span>
</span><span id="line-608"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span id="local-6989586621679335064"><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679335064"><span class="hs-identifier hs-var">pending</span></a></span></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map CanisterId CanState -&gt; [CanState]
forall k a. Map k a -&gt; [a]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#elems"><span class="hs-identifier hs-var">M.elems</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335071"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-609"></span><span>  </span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335065"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335065"><span class="hs-identifier hs-var">c'</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><a href="#local-6989586621679335064"><span class="hs-identifier hs-var">pending</span></a></span><span>
</span><span id="line-610"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-611"></span><span>  </span><span class="hs-comment">-- NB: this could be implemented more efficient if kepts a counter of</span><span>
</span><span id="line-612"></span><span>  </span><span class="hs-comment">-- outstanding calls in each call context</span><span>
</span><span id="line-613"></span><span>
</span><span id="line-614"></span><span class="hs-comment">-- | Find a starved call context</span><span>
</span><span id="line-615"></span><span id="local-6989586621679336629"><span class="annot"><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-type">nextStarved</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336629"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336629"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallId"><span class="hs-identifier hs-type">CallId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-616"></span><span id="nextStarved"><span class="annot"><span class="annottext">nextStarved :: forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CallId)
</span><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-var hs-var">nextStarved</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe CallId) -&gt; m (Maybe CallId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; Maybe CallId) -&gt; m (Maybe CallId))
-&gt; (IC -&gt; Maybe CallId) -&gt; m (Maybe CallId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335059"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335059"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[CallId] -&gt; Maybe CallId
forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-617"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335058"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-618"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335058"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335058"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: CallContext -&gt; NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-type">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-special">}</span><span> </span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map CallId CallContext -&gt; [(CallId, CallContext)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CallId CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335059"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-619"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">(Bool -&gt; Bool) -&gt; Bool -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; CallId -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var">willReceiveResponse</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335059"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335058"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-620"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-621"></span><span>
</span><span id="line-622"></span><span class="hs-comment">-- | Find a canister in stopping state that is, well, stopped</span><span>
</span><span id="line-623"></span><span id="local-6989586621679336627"><span class="annot"><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-type">nextStoppedCanister</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336627"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336627"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-624"></span><span id="nextStoppedCanister"><span class="annot"><span class="annottext">nextStoppedCanister :: forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CanisterId)
</span><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-var hs-var">nextStoppedCanister</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; Maybe CanisterId) -&gt; m (Maybe CanisterId)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; Maybe CanisterId) -&gt; m (Maybe CanisterId))
-&gt; (IC -&gt; Maybe CanisterId) -&gt; m (Maybe CanisterId)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335051"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335051"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">[CanisterId] -&gt; Maybe CanisterId
forall a. [a] -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Maybe.html#listToMaybe"><span class="hs-identifier hs-var">listToMaybe</span></a></span><span>
</span><span id="line-625"></span><span>  </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335050"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-626"></span><span>  </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335050"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335050"><span class="hs-identifier hs-var">cid</span></a></span></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#CanState"><span class="hs-identifier hs-type">CanState</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">run_status :: CanState -&gt; RunStatus
</span><a href="IC.Ref.Types.html#run_status"><span class="hs-identifier hs-var">run_status</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#IsStopping"><span class="hs-identifier hs-type">IsStopping</span></a></span><span> </span><span class="annot"><span class="annottext">[CallId]
</span><span class="hs-identifier">_</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map CanisterId CanState -&gt; [(CanisterId, CanState)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335051"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-627"></span><span>  </span><span class="hs-comment">-- no call context still waiting for a response</span><span>
</span><span id="line-628"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">[()] -&gt; Bool
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#null"><span class="hs-identifier hs-var">null</span></a></span><span> </span><span class="hs-special">[</span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span><span>
</span><span id="line-629"></span><span>    </span><span class="hs-glyph">|</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679335048"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335048"><span class="hs-identifier hs-var">c</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679335047"><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335047"><span class="hs-identifier hs-var">ctxt</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Map CallId CallContext -&gt; [(CallId, CallContext)]
forall k a. Map k a -&gt; [(k, a)]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#toList"><span class="hs-identifier hs-var">M.toList</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CallId CallContext
</span><a href="IC.Ref.Types.html#call_contexts"><span class="hs-identifier hs-var hs-var">call_contexts</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335051"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-630"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var hs-var">canister</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335047"><span class="hs-identifier hs-var">ctxt</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; CanisterId -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3D%3D"><span class="hs-operator hs-var">==</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679335050"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-631"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">CallContext -&gt; Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var hs-var">deleted</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext
</span><a href="#local-6989586621679335047"><span class="hs-identifier hs-var">ctxt</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-632"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC -&gt; CallId -&gt; Bool
</span><a href="IC.Ref.html#willReceiveResponse"><span class="hs-identifier hs-var">willReceiveResponse</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335051"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679335048"><span class="hs-identifier hs-var">c</span></a></span><span>
</span><span id="line-633"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-634"></span><span>  </span><span class="hs-special">]</span><span>
</span><span id="line-635"></span><span>
</span><span id="line-636"></span><span>
</span><span id="line-637"></span><span class="hs-comment">-- | Pick (and remove) next message from queue</span><span>
</span><span id="line-638"></span><span id="local-6989586621679336624"><span class="annot"><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-type">popMessage</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336624"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336624"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#Message"><span class="hs-identifier hs-type">Message</span></a></span><span class="hs-special">)</span></span><span>
</span><span id="line-639"></span><span id="popMessage"><span class="annot"><span class="annottext">popMessage :: forall (m :: * -&gt; *). ICM m =&gt; m (Maybe Message)
</span><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-var hs-var">popMessage</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; (Maybe Message, IC)) -&gt; m (Maybe Message)
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; (a, s)) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#state"><span class="hs-identifier hs-var">state</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; (Maybe Message, IC)) -&gt; m (Maybe Message))
-&gt; (IC -&gt; (Maybe Message, IC)) -&gt; m (Maybe Message)
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679335042"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335042"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span>
</span><span id="line-640"></span><span>  </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">IC -&gt; Seq Message
</span><a href="IC.Ref.Types.html#messages"><span class="hs-identifier hs-var hs-var">messages</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335042"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-641"></span><span>    </span><span class="annot"><span class="annottext">Seq Message
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Sequence.Internal.html#Empty"><span class="hs-identifier hs-var">Empty</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe Message
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335042"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-642"></span><span>    </span><span id="local-6989586621679335040"><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679335040"><span class="hs-identifier hs-var">m</span></a></span></span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Sequence.Internal.html#%3A%3C%7C"><span class="hs-operator hs-type">:&lt;|</span></a></span><span> </span><span id="local-6989586621679335038"><span class="annot"><span class="annottext">Seq Message
</span><a href="#local-6989586621679335038"><span class="hs-identifier hs-var">ms</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Message -&gt; Maybe Message
forall a. a -&gt; Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-var">Just</span></a></span><span> </span><span class="annot"><span class="annottext">Message
</span><a href="#local-6989586621679335040"><span class="hs-identifier hs-var">m</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335042"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">messages :: Seq Message
</span><a href="IC.Ref.Types.html#messages"><span class="hs-identifier hs-var">messages</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Seq Message
</span><a href="#local-6989586621679335038"><span class="hs-identifier hs-var">ms</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span>
</span><span id="line-643"></span><span>
</span><span id="line-644"></span><span class="hs-comment">-- | Fake time increase</span><span>
</span><span id="line-645"></span><span id="local-6989586621679336622"><span class="annot"><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-type">bumpTime</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336622"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336622"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-646"></span><span id="bumpTime"><span class="annot"><span class="annottext">bumpTime :: forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-var hs-var">bumpTime</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-647"></span><span>  </span><span class="hs-glyph">\</span><span id="local-6989586621679335030"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335030"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335030"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; CanState)
-&gt; Map CanisterId CanState -&gt; Map CanisterId CanState
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#map"><span class="hs-identifier hs-var">M.map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679335028"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335028"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335028"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="IC.Ref.Types.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Timestamp
</span><a href="IC.Ref.Types.html#time"><span class="hs-identifier hs-var hs-var">time</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335028"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">Timestamp -&gt; Timestamp -&gt; Timestamp
forall a. Num a =&gt; a -&gt; a -&gt; a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Num.html#%2B"><span class="hs-operator hs-var">+</span></a></span><span class="annot"><span class="annottext">Timestamp
</span><span class="hs-number">1</span></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335030"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-648"></span><span>
</span><span id="line-649"></span><span id="local-6989586621679336617"><span class="annot"><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier hs-type">setAllTimesTo</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336617"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336617"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-650"></span><span id="setAllTimesTo"><span class="annot"><span class="annottext">setAllTimesTo :: forall (m :: * -&gt; *). ICM m =&gt; Timestamp -&gt; m ()
</span><a href="IC.Ref.html#setAllTimesTo"><span class="hs-identifier hs-var hs-var">setAllTimesTo</span></a></span></span><span> </span><span id="local-6989586621679335023"><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335023"><span class="hs-identifier hs-var">ts</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; IC) -&gt; m ()
forall s (m :: * -&gt; *). MonadState s m =&gt; (s -&gt; s) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#modify"><span class="hs-identifier hs-var">modify</span></a></span><span> </span><span class="annot"><span class="annottext">((IC -&gt; IC) -&gt; m ()) -&gt; (IC -&gt; IC) -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span>
</span><span id="line-651"></span><span>  </span><span class="hs-glyph">\</span><span id="local-6989586621679335022"><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335022"><span class="hs-identifier hs-var">ic</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335022"><span class="hs-identifier hs-var">ic</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canisters :: Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var">canisters</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(CanState -&gt; CanState)
-&gt; Map CanisterId CanState -&gt; Map CanisterId CanState
forall a b k. (a -&gt; b) -&gt; Map k a -&gt; Map k b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#map"><span class="hs-identifier hs-var">M.map</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679335021"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335021"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679335021"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">time :: Timestamp
</span><a href="IC.Ref.Types.html#time"><span class="hs-identifier hs-var">time</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Timestamp
</span><a href="#local-6989586621679335023"><span class="hs-identifier hs-var">ts</span></a></span><span> </span><span class="hs-special">}</span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">IC -&gt; Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span> </span><span class="annot"><span class="annottext">IC
</span><a href="#local-6989586621679335022"><span class="hs-identifier hs-var">ic</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-652"></span><span>
</span><span id="line-653"></span><span id="local-6989586621679335020"><span class="annot"><a href="IC.Ref.html#runHeartbeat"><span class="hs-identifier hs-type">runHeartbeat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679335020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679335020"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-654"></span><span id="runHeartbeat"><span class="annot"><span class="annottext">runHeartbeat :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runHeartbeat"><span class="hs-identifier hs-var hs-var">runHeartbeat</span></a></span></span><span> </span><span id="local-6989586621679334990"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334990"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-655"></span><span>  </span><span id="local-6989586621679334989"><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679334989"><span class="hs-identifier hs-var">can</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m CanState
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m CanState
</span><a href="IC.Ref.Types.html#getCanister"><span class="hs-identifier hs-var">getCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334990"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-656"></span><span>  </span><span id="local-6989586621679334987"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334987"><span class="hs-identifier hs-var">is_empty</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334990"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-657"></span><span>  </span><span id="local-6989586621679334986"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334986"><span class="hs-identifier hs-var">is_running</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var">isCanisterRunning</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334990"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-658"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Maybe EntryPoint -&gt; Bool
</span><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-var">idleSinceLastHeartbeat</span></a></span><span> </span><span class="annot"><span class="annottext">(Maybe EntryPoint -&gt; Bool) -&gt; Maybe EntryPoint -&gt; Bool
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CanState -&gt; Maybe EntryPoint
</span><a href="IC.Ref.Types.html#last_action"><span class="hs-identifier hs-var hs-var">last_action</span></a></span><span> </span><span class="annot"><span class="annottext">CanState
</span><a href="#local-6989586621679334989"><span class="hs-identifier hs-var">can</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334987"><span class="hs-identifier hs-var">is_empty</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334986"><span class="hs-identifier hs-var">is_running</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-659"></span><span>    </span><span id="local-6989586621679334983"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679334983"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; m CallId
forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; m CallId) -&gt; CallContext -&gt; m CallId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext :: CanisterId
-&gt; CallOrigin
-&gt; NeedsToRespond
-&gt; Bool
-&gt; Natural
-&gt; Maybe MethodName
-&gt; CallContext
</span><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-660"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334990"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-661"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallOrigin
</span><a href="IC.Ref.Types.html#FromSystemTask"><span class="hs-identifier hs-var">FromSystemTask</span></a></span><span>
</span><span id="line-662"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-663"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-664"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe MethodName
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe MethodName
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-665"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-666"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-667"></span><span>    </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var">processMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m ()) -&gt; Message -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallMessage :: CallId -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-668"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679334983"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span>
</span><span id="line-669"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#Heartbeat"><span class="hs-identifier hs-var">Heartbeat</span></a></span><span>
</span><span id="line-670"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-671"></span><span>
</span><span id="line-672"></span><span id="local-6989586621679334982"><span class="annot"><a href="IC.Ref.html#runGlobalTimer"><span class="hs-identifier hs-type">runGlobalTimer</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679334982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="IC.Types.html#CanisterId"><span class="hs-identifier hs-type">CanisterId</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679334982"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-673"></span><span id="runGlobalTimer"><span class="annot"><span class="annottext">runGlobalTimer :: forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runGlobalTimer"><span class="hs-identifier hs-var hs-var">runGlobalTimer</span></a></span></span><span> </span><span id="local-6989586621679334939"><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334939"><span class="hs-identifier hs-var">cid</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-674"></span><span>  </span><span id="local-6989586621679334938"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334938"><span class="hs-identifier hs-var">is_empty</span></a></span></span><span>   </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.Types.html#isCanisterEmpty"><span class="hs-identifier hs-var">isCanisterEmpty</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334939"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-675"></span><span>  </span><span id="local-6989586621679334937"><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334937"><span class="hs-identifier hs-var">is_running</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Bool
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Bool
</span><a href="IC.Ref.html#isCanisterRunning"><span class="hs-identifier hs-var">isCanisterRunning</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334939"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-676"></span><span>  </span><span class="annot"><a href="IC.Types.html#Timestamp"><span class="hs-identifier hs-type">Timestamp</span></a></span><span> </span><span id="local-6989586621679334936"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679334936"><span class="hs-identifier hs-var">current_time</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Timestamp
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Timestamp
</span><a href="IC.Ref.Types.html#getCanisterTime"><span class="hs-identifier hs-var">getCanisterTime</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334939"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-677"></span><span>  </span><span id="local-6989586621679334934"><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679334934"><span class="hs-identifier hs-var">global_timer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m Natural
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m Natural
</span><a href="IC.Ref.Types.html#getCanisterGlobalTimer"><span class="hs-identifier hs-var">getCanisterGlobalTimer</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334939"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-678"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679334932"><span class="annot"><span class="annottext">should_fire :: Bool
</span><a href="#local-6989586621679334932"><span class="hs-identifier hs-var hs-var">should_fire</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679334934"><span class="hs-identifier hs-var">global_timer</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%2F%3D"><span class="hs-operator hs-var">/=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679334936"><span class="hs-identifier hs-var">current_time</span></a></span><span> </span><span class="annot"><span class="annottext">Natural -&gt; Natural -&gt; Bool
forall a. Ord a =&gt; a -&gt; a -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%3E%3D"><span class="hs-operator hs-var">&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><a href="#local-6989586621679334934"><span class="hs-identifier hs-var">global_timer</span></a></span><span>
</span><span id="line-679"></span><span>  </span><span class="annot"><span class="annottext">Bool -&gt; m () -&gt; m ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#when"><span class="hs-identifier hs-var">when</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334932"><span class="hs-identifier hs-var">should_fire</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334937"><span class="hs-identifier hs-var">is_running</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#%26%26"><span class="hs-operator hs-var">&amp;&amp;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Classes.html#not"><span class="hs-identifier hs-var">not</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="#local-6989586621679334938"><span class="hs-identifier hs-var">is_empty</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(m () -&gt; m ()) -&gt; m () -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-680"></span><span>    </span><span class="annot"><span class="annottext">CanisterId -&gt; Natural -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; Natural -&gt; m ()
</span><a href="IC.Ref.Types.html#setCanisterGlobalTimer"><span class="hs-identifier hs-var">setCanisterGlobalTimer</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334939"><span class="hs-identifier hs-var">cid</span></a></span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-681"></span><span>    </span><span id="local-6989586621679334930"><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679334930"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">CallContext -&gt; m CallId
forall (m :: * -&gt; *). ICM m =&gt; CallContext -&gt; m CallId
</span><a href="IC.Ref.html#newCallContext"><span class="hs-identifier hs-var">newCallContext</span></a></span><span> </span><span class="annot"><span class="annottext">(CallContext -&gt; m CallId) -&gt; CallContext -&gt; m CallId
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallContext :: CanisterId
-&gt; CallOrigin
-&gt; NeedsToRespond
-&gt; Bool
-&gt; Natural
-&gt; Maybe MethodName
-&gt; CallContext
</span><a href="IC.Ref.Types.html#CallContext"><span class="hs-identifier hs-type">CallContext</span></a></span><span>
</span><span id="line-682"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">canister :: CanisterId
</span><a href="IC.Ref.Types.html#canister"><span class="hs-identifier hs-var">canister</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CanisterId
</span><a href="#local-6989586621679334939"><span class="hs-identifier hs-var">cid</span></a></span><span>
</span><span id="line-683"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">origin :: CallOrigin
</span><a href="IC.Ref.Types.html#origin"><span class="hs-identifier hs-var">origin</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallOrigin
</span><a href="IC.Ref.Types.html#FromSystemTask"><span class="hs-identifier hs-var">FromSystemTask</span></a></span><span>
</span><span id="line-684"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">needs_to_respond :: NeedsToRespond
</span><a href="IC.Ref.Types.html#needs_to_respond"><span class="hs-identifier hs-var">needs_to_respond</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; NeedsToRespond
</span><a href="IC.Types.html#NeedsToRespond"><span class="hs-identifier hs-var">NeedsToRespond</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-685"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">deleted :: Bool
</span><a href="IC.Ref.Types.html#deleted"><span class="hs-identifier hs-var">deleted</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-686"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">last_trap :: Maybe MethodName
</span><a href="IC.Ref.Types.html#last_trap"><span class="hs-identifier hs-var">last_trap</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Maybe MethodName
forall a. Maybe a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Nothing"><span class="hs-identifier hs-var">Nothing</span></a></span><span>
</span><span id="line-687"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">available_cycles :: Natural
</span><a href="IC.Ref.Types.html#available_cycles"><span class="hs-identifier hs-var">available_cycles</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Natural
</span><span class="hs-number">0</span></span><span>
</span><span id="line-688"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-689"></span><span>    </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var">processMessage</span></a></span><span> </span><span class="annot"><span class="annottext">(Message -&gt; m ()) -&gt; Message -&gt; m ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%24"><span class="hs-operator hs-var">$</span></a></span><span> </span><span class="annot"><span class="annottext">CallMessage :: CallId -&gt; EntryPoint -&gt; Message
</span><a href="IC.Ref.Types.html#CallMessage"><span class="hs-identifier hs-type">CallMessage</span></a></span><span>
</span><span id="line-690"></span><span>      </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">call_context :: CallId
</span><a href="IC.Ref.Types.html#call_context"><span class="hs-identifier hs-var">call_context</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">CallId
</span><a href="#local-6989586621679334930"><span class="hs-identifier hs-var">new_ctxt_id</span></a></span><span>
</span><span id="line-691"></span><span>      </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">entry :: EntryPoint
</span><a href="IC.Ref.Types.html#entry"><span class="hs-identifier hs-var">entry</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#GlobalTimer"><span class="hs-identifier hs-var">GlobalTimer</span></a></span><span>
</span><span id="line-692"></span><span>      </span><span class="hs-special">}</span><span>
</span><span id="line-693"></span><span>
</span><span id="line-694"></span><span id="local-6989586621679334929"><span class="annot"><a href="IC.Ref.html#processSystemTasks"><span class="hs-identifier hs-type">processSystemTasks</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679334929"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679334929"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-695"></span><span id="processSystemTasks"><span class="annot"><span class="annottext">processSystemTasks :: forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#processSystemTasks"><span class="hs-identifier hs-var hs-var">processSystemTasks</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-696"></span><span>  </span><span id="local-6989586621679334909"><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679334909"><span class="hs-identifier hs-var">cs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(IC -&gt; [CanisterId]) -&gt; m [CanisterId]
forall s (m :: * -&gt; *) a. MonadState s m =&gt; (s -&gt; a) -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/mtl-2.2.2/src/Control.Monad.State.Class.html#gets"><span class="hs-identifier hs-var">gets</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Map CanisterId CanState -&gt; [CanisterId]
forall k a. Map k a -&gt; [k]
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/containers-0.6.4.1/src/Data.Map.Internal.html#keys"><span class="hs-identifier hs-var">M.keys</span></a></span><span> </span><span class="annot"><span class="annottext">(Map CanisterId CanState -&gt; [CanisterId])
-&gt; (IC -&gt; Map CanisterId CanState) -&gt; IC -&gt; [CanisterId]
forall b c a. (b -&gt; c) -&gt; (a -&gt; b) -&gt; a -&gt; c
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#."><span class="hs-operator hs-var">.</span></a></span><span> </span><span class="annot"><span class="annottext">IC -&gt; Map CanisterId CanState
</span><a href="IC.Ref.Types.html#canisters"><span class="hs-identifier hs-var hs-var">canisters</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-697"></span><span>  </span><span class="annot"><span class="annottext">[CanisterId] -&gt; (CanisterId -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679334909"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runHeartbeat"><span class="hs-identifier hs-var">runHeartbeat</span></a></span><span>
</span><span id="line-698"></span><span>  </span><span class="annot"><span class="annottext">[CanisterId] -&gt; (CanisterId -&gt; m ()) -&gt; m ()
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Foldable t, Monad m) =&gt;
t a -&gt; (a -&gt; m b) -&gt; m ()
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#forM_"><span class="hs-identifier hs-var">forM_</span></a></span><span> </span><span class="annot"><span class="annottext">[CanisterId]
</span><a href="#local-6989586621679334909"><span class="hs-identifier hs-var">cs</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#runGlobalTimer"><span class="hs-identifier hs-var">runGlobalTimer</span></a></span><span>
</span><span id="line-699"></span><span>
</span><span id="line-700"></span><span class="annot"><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-type">idleSinceLastHeartbeat</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Maybe"><span class="hs-identifier hs-type">Maybe</span></a></span><span> </span><span class="annot"><a href="IC.Ref.Types.html#EntryPoint"><span class="hs-identifier hs-type">EntryPoint</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span><span>
</span><span id="line-701"></span><span id="idleSinceLastHeartbeat"><span class="annot"><span class="annottext">idleSinceLastHeartbeat :: Maybe EntryPoint -&gt; Bool
</span><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-var hs-var">idleSinceLastHeartbeat</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Maybe.html#Just"><span class="hs-identifier hs-type">Just</span></a></span><span> </span><span class="annot"><span class="annottext">EntryPoint
</span><a href="IC.Ref.Types.html#Heartbeat"><span class="hs-identifier hs-var">Heartbeat</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span>
</span><span id="line-702"></span><span class="annot"><a href="IC.Ref.html#idleSinceLastHeartbeat"><span class="hs-identifier hs-var">idleSinceLastHeartbeat</span></a></span><span> </span><span class="annot"><span class="annottext">Maybe EntryPoint
</span><span class="hs-identifier">_</span></span><span>                </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span>
</span><span id="line-703"></span><span>
</span><span id="line-704"></span><span class="hs-comment">-- | Returns true if a step was taken</span><span>
</span><span id="line-705"></span><span id="local-6989586621679336608"><span class="annot"><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-type">runStep</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679336608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679336608"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#Bool"><span class="hs-identifier hs-type">Bool</span></a></span></span><span>
</span><span id="line-706"></span><span id="runStep"><span class="annot"><span class="annottext">runStep :: forall (m :: * -&gt; *). ICM m =&gt; m Bool
</span><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-var hs-var">runStep</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-707"></span><span>  </span><span class="annot"><span class="annottext">m ()
forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#bumpTime"><span class="hs-identifier hs-var">bumpTime</span></a></span><span>
</span><span id="line-708"></span><span>  </span><span class="annot"><span class="annottext">[m Bool] -&gt; m Bool
</span><a href="#local-6989586621679334869"><span class="hs-identifier hs-var">try</span></a></span><span>
</span><span id="line-709"></span><span>    </span><span class="hs-special">[</span><span> </span><span class="annot"><span class="annottext">m (Maybe (Blob, CallRequest, CanisterId))
-&gt; ((Blob, CallRequest, CanisterId) -&gt; m ()) -&gt; m Bool
forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679334868"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe (Blob, CallRequest, CanisterId))
forall (m :: * -&gt; *).
ICM m =&gt;
m (Maybe (Blob, CallRequest, CanisterId))
</span><a href="IC.Ref.html#nextReceived"><span class="hs-identifier hs-var">nextReceived</span></a></span><span> </span><span class="annot"><span class="annottext">(Blob, CallRequest, CanisterId) -&gt; m ()
forall (m :: * -&gt; *).
ICM m =&gt;
(Blob, CallRequest, CanisterId) -&gt; m ()
</span><a href="IC.Ref.html#processRequest"><span class="hs-identifier hs-var">processRequest</span></a></span><span>
</span><span id="line-710"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (Maybe Message) -&gt; (Message -&gt; m ()) -&gt; m Bool
forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679334868"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe Message)
forall (m :: * -&gt; *). ICM m =&gt; m (Maybe Message)
</span><a href="IC.Ref.html#popMessage"><span class="hs-identifier hs-var">popMessage</span></a></span><span> </span><span class="annot"><span class="annottext">Message -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; Message -&gt; m ()
</span><a href="IC.Ref.html#processMessage"><span class="hs-identifier hs-var">processMessage</span></a></span><span>
</span><span id="line-711"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (Maybe CallId) -&gt; (CallId -&gt; m ()) -&gt; m Bool
forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679334868"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe CallId)
forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CallId)
</span><a href="IC.Ref.html#nextStarved"><span class="hs-identifier hs-var">nextStarved</span></a></span><span> </span><span class="annot"><span class="annottext">CallId -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CallId -&gt; m ()
</span><a href="IC.Ref.html#starveCallContext"><span class="hs-identifier hs-var">starveCallContext</span></a></span><span>
</span><span id="line-712"></span><span>    </span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">m (Maybe CanisterId) -&gt; (CanisterId -&gt; m ()) -&gt; m Bool
forall {m :: * -&gt; *} {t} {a}.
Monad m =&gt;
m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679334868"><span class="hs-identifier hs-var">with</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe CanisterId)
forall (m :: * -&gt; *). ICM m =&gt; m (Maybe CanisterId)
</span><a href="IC.Ref.html#nextStoppedCanister"><span class="hs-identifier hs-var">nextStoppedCanister</span></a></span><span> </span><span class="annot"><span class="annottext">CanisterId -&gt; m ()
forall (m :: * -&gt; *). ICM m =&gt; CanisterId -&gt; m ()
</span><a href="IC.Ref.html#actuallyStopCanister"><span class="hs-identifier hs-var">actuallyStopCanister</span></a></span><span>
</span><span id="line-713"></span><span>    </span><span class="hs-special">]</span><span>
</span><span id="line-714"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-715"></span><span>    </span><span id="local-6989586621679334869"><span class="annot"><span class="annottext">try :: [m Bool] -&gt; m Bool
</span><a href="#local-6989586621679334869"><span class="hs-identifier hs-var hs-var">try</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(m Bool -&gt; m Bool -&gt; m Bool) -&gt; m Bool -&gt; [m Bool] -&gt; m Bool
forall (t :: * -&gt; *) a b.
Foldable t =&gt;
(a -&gt; b -&gt; b) -&gt; b -&gt; t a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Foldable.html#foldr"><span class="hs-identifier hs-var">foldr</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679334862"><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679334862"><span class="hs-identifier hs-var">g</span></a></span></span><span> </span><span id="local-6989586621679334861"><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679334861"><span class="hs-identifier hs-var">r</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679334862"><span class="hs-identifier hs-var">g</span></a></span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; (Bool -&gt; m Bool) -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="hs-glyph">\</span><span class="hs-glyph">case</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">;</span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">m Bool
</span><a href="#local-6989586621679334861"><span class="hs-identifier hs-var">r</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-716"></span><span>    </span><span id="local-6989586621679334868"><span class="annot"><span class="annottext">with :: m (Maybe t) -&gt; (t -&gt; m a) -&gt; m Bool
</span><a href="#local-6989586621679334868"><span class="hs-identifier hs-var hs-var">with</span></a></span></span><span> </span><span id="local-6989586621679334855"><span class="annot"><span class="annottext">m (Maybe t)
</span><a href="#local-6989586621679334855"><span class="hs-identifier hs-var">sel</span></a></span></span><span> </span><span id="local-6989586621679334854"><span class="annot"><span class="annottext">t -&gt; m a
</span><a href="#local-6989586621679334854"><span class="hs-identifier hs-var">act</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m (Maybe t)
</span><a href="#local-6989586621679334855"><span class="hs-identifier hs-var">sel</span></a></span><span> </span><span class="annot"><span class="annottext">m (Maybe t) -&gt; (Maybe t -&gt; m Bool) -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; (a -&gt; m b) -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E%3D"><span class="hs-operator hs-var">&gt;&gt;=</span></a></span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; (t -&gt; m Bool) -&gt; Maybe t -&gt; m Bool
forall b a. b -&gt; (a -&gt; b) -&gt; Maybe a -&gt; b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/Data.Maybe.html#maybe"><span class="hs-identifier hs-var">maybe</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#False"><span class="hs-identifier hs-var">False</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">(</span><span class="hs-glyph">\</span><span id="local-6989586621679334852"><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679334852"><span class="hs-identifier hs-var">x</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">t -&gt; m a
</span><a href="#local-6989586621679334854"><span class="hs-identifier hs-var">act</span></a></span><span> </span><span class="annot"><span class="annottext">t
</span><a href="#local-6989586621679334852"><span class="hs-identifier hs-var">x</span></a></span><span> </span><span class="annot"><span class="annottext">m a -&gt; m Bool -&gt; m Bool
forall (m :: * -&gt; *) a b. Monad m =&gt; m a -&gt; m b -&gt; m b
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#%3E%3E"><span class="hs-operator hs-var">&gt;&gt;</span></a></span><span> </span><span class="annot"><span class="annottext">Bool -&gt; m Bool
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/base-4.15.1.0/src/GHC.Base.html#return"><span class="hs-identifier hs-var">return</span></a></span><span> </span><span class="annot"><span class="annottext">Bool
</span><a href="file:///nix/store/sq3hm1arb77zb833mld18fi4liydbf18-ghc-9.0.2-doc/share/doc/ghc/html/libraries/ghc-prim-0.7.0/src/GHC.Types.html#True"><span class="hs-identifier hs-var">True</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-717"></span><span>
</span><span id="line-718"></span><span id="local-6989586621679334851"><span class="annot"><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier hs-type">runToCompletion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="IC.Ref.Types.html#ICM"><span class="hs-identifier hs-type">ICM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679334851"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679334851"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-special">(</span><span class="hs-special">)</span></span><span>
</span><span id="line-719"></span><span id="runToCompletion"><span class="annot"><span class="annottext">runToCompletion :: forall (m :: * -&gt; *). ICM m =&gt; m ()
</span><a href="IC.Ref.html#runToCompletion"><span class="hs-identifier hs-var hs-var">runToCompletion</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">m Bool -&gt; m ()
forall (m :: * -&gt; *). Monad m =&gt; m Bool -&gt; m ()
</span><a href="IC.Utils.html#repeatWhileTrue"><span class="hs-identifier hs-var">repeatWhileTrue</span></a></span><span> </span><span class="annot"><span class="annottext">m Bool
forall (m :: * -&gt; *). ICM m =&gt; m Bool
</span><a href="IC.Ref.html#runStep"><span class="hs-identifier hs-var">runStep</span></a></span><span>
</span><span id="line-720"></span></pre></body></html>